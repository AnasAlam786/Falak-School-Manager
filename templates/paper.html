{% extends "base.html" %}
{% block title %}Create Paper{% endblock %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<div class="d-flex flex-column justify-content-center align-items-center mb-3">
  <h1 class="fw-bold text-center mb-2">{{ session['school_name'] }}</h1>

  <input type="text" class="event form-control text-center fw-bold mb-2 w-75" list="EventList" placeholder="Event">
  <datalist id="EventList">
    <option value="Formative Assessment - I">
    <option value="Summative Assessment - I">
    <option value="Formative Assessment - II">
    <option value="Summative Assessment - II">
  </datalist>

  <input type="text" class="subject form-control text-center fw-bold mb-2 w-50" list="SubjectList" placeholder="Subject">
  <datalist id="SubjectList">
    <option value="English">
    <option value="Hindi">
    <option value="Math">
    <option value="Science">
    <option value="Computer">
    <option value="S.S.T">
    <option value="Urdu">
    <option value="G.K">
  </datalist>

  <div class="d-flex justify-content-between">
    <input type="text" class="hrs form-control text-center fw-bold" style="width: 60px;" placeholder="hrs">

    <input type="text" class="class form-control text-center fw-bold" style="width: 25%;" list="ClassList" placeholder="Class">
    <datalist id="ClassList">
      <option value="Nursery">
      <option value="LKG">
      <option value="UKG">
      <option value="I">
      <option value="II">
      <option value="III">
      <option value="IV">
      <option value="V">
      <option value="VI">
      <option value="VII">
      <option value="VIII">
    </datalist>

    <input type="text" class="M-M form-control text-center fw-bold" style="width: 60px;" list="mList" placeholder="M.M">
    <datalist id="mList">
      <option value="20">
      <option value="80">
    </datalist>

  </div>
</div>


<div id="content" style="width: 100%;">
  <div  class="d-flex flex-column align-items-end mb-4" id="Question-{{ index }}">

    <div class="question input-group mb-1">
        <select  class="form-select fw-bold" rows="1" style="overflow: hidden; resize: none;" onchange="addQuestion(this)">
          <option selected>Select Question Type</option>
          <option value="mcq">Multiple Choice Questions</option>
          <option value="fillUp">Fill In The Blanks</option>
          <option value="T-F">True or False</option>
          <option value="match">Matching</option>
          <option value="QnA">Question & Answers</option>
          <option value="singleWord">Single Word Questions</option>
        </select>
        
        <button class="btn btn-success ms-1" onclick="addQuestion(this)" style="width: 35px; height: 40px;">+</button>
        <button class="btn btn-danger ms-1" onclick="remove(this)" style="width: 35px; height: 40px;">-</button>
    </div>

  </div>
</div>



<div class="container text-center mt-3">
    <button class="btn btn-primary w-75" onclick="convert()">Convert</button>
</div>

<button onclick="downloadPDF()">Download PDF</button>


<div id="a4PDF" class="a4-paper">

</div>


<script>

function downloadPDF() {
    const element = document.getElementById("a4PDF");

    const { jsPDF } = window.jspdf;

    // Assuming you have included jsPDF and html2canvas via CDN or import statements
    const pdf = new jsPDF({ unit: "mm", format: "a4", orientation: "portrait" });

    html2canvas(document.getElementById("a4PDF"), { scale: 5 }).then(canvas => {
    const imgData = canvas.toDataURL("image/jpeg", 1.0);
    const pdfWidth = 210; // Fixed width for A4
    const ratio = canvas.height / canvas.width;
    const imgHeight = pdfWidth * ratio;
    
    pdf.addImage(imgData, "JPEG", 0, 0, pdfWidth, imgHeight);
    pdf.save("output.pdf");
    });



}



    var questionCount=1

    function addQuestion(element) {
      const parent = element.parentElement;
      const grandparent = parent.parentElement
      

      if (element.tagName.toLowerCase() === 'select') {
        const qtext = element.options[element.selectedIndex].innerText;
        const siblings = Array.from(grandparent.children).filter(child => child !== parent);
        
        siblings.forEach(sibling => sibling.remove());

        const div = document.createElement('div')
        div.className = "d-flex w-100"

        const qinput = document.createElement('input');
        qinput.type = 'text';
        qinput.value = qtext
        qinput.className = 'form-control mb-2 me-1 q-text'
        qinput.onclick = function() { this.select(); };
        qinput.placeholder = 'Enter Question Text';

        const mInput = document.createElement('input');
        mInput.type = 'number';
        mInput.className = 'form-control mb-2 m-text';
        mInput.onclick = function() { this.select(); };
        mInput.placeholder = 'Marks';
        mInput.style="width: 75px;"

        div.appendChild(qinput)
        div.appendChild(mInput)
        
        parent.insertAdjacentElement('afterend', div);
        updatePage('/paper', grandparent.id , { value : element.value }, append="beforeend");
        
      }
      
      else if (parent.classList.contains('question')){
        questionCount++;
        updatePage('/paper', element.parentElement.parentElement.id , { value : questionCount }, append="afterend");
      }
      else{
        updatePage('/paper', grandparent.id , { value : parent.id }, append="beforeend");
      }
      
    }
    function remove(element) {
      const parent = element.parentElement;
      if (parent.classList.contains('question')){
        parent.parentElement.remove()
      }
      else{parent.remove()}
    }

    function convert() {

      let questions = [];

      const ele = document.querySelectorAll('.mcq, .fillUp, .match, .QnA, .T-F');
      let elements = document.querySelectorAll('[id^="Question-"]');
      qText={"fillUp":"Fill Ups",
          "T-F":"True or False",
          "QnA":"Question and Answer"}

      elements.forEach(el => {
        let q=el.querySelectorAll('.mcq, .fillUp, .match, .QnA, .T-F, .singleWord');
        if (q.length === 0) {alert("Please select all the select ."); return 0};

        if (q[0].id==="fillUp" || q[0].id==="T-F" || q[0].id==="QnA"){
          questions.push({
            "marks": el.querySelectorAll('[class*="m-text"]')[0].value,
            "qText": el.querySelectorAll('[class*="q-text"]')[0].value,
            "type": q[0].id,
            "subQuestion": [...el.querySelectorAll('.sub-question')].map(q => q.value), })
        }

        if (q[0].id==="match"){
          questions.push({
            "marks": el.querySelectorAll('[class*="m-text"]')[0].value,
            "qText": el.querySelectorAll('[class*="q-text"]')[0].value,
            "type": "match",
            "subQuestion": [...el.querySelectorAll('.sub-question')].map(q => q.value),
            "options": [...el.querySelectorAll('.option')].map(q => q.value)})
        }

        if (q[0].id==="singleWord"){
          questions.push({
            "marks": el.querySelectorAll('[class*="m-text"]')[0].value,
            "qText": el.querySelectorAll('[class*="q-text"]')[0].value,
            "type": "singleWord",
            "subQuestion": [...el.querySelectorAll('.sub-question')].map(q => q.value),})
        }

        if (q[0].id==="mcq"){
          var mcqs=el.querySelectorAll('.mcq')

          questions.push({
            "marks": el.querySelectorAll('[class*="m-text"]')[0].value,
            "qText": el.querySelectorAll('[class*="q-text"]')[0].value,
            "type": "mcq",
            "subQuestion": [...mcqs].map(mcq => ({
                  "text": mcq.querySelector('.sub-question').value,
                  "options": [...mcq.querySelectorAll('.option')].map(opt => opt.value)
              }))
            })
        };
        
      })
      event=document.getElementsByClassName("event")[0].value
      subject=document.getElementsByClassName("subject")[0].value
      std=document.getElementsByClassName("class")[0].value
      hrs=document.getElementsByClassName("hrs")[0].value
      MM=document.getElementsByClassName("M-M")[0].value


      updatePage('/paper', "a4PDF" , { questions:questions, event:event, subject:subject, std:std, hrs:hrs, MM:MM, value:"a4PDF" });


    }

    function adjustHeight(element) {
      element.style.height = "auto"; // Reset the height
      element.style.height = (element.scrollHeight) + "px"; // Set to scroll height
    }
  </script>

{% endblock %}
