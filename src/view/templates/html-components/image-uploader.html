{% macro render_image_uploader(unique_suffix='', label='Upload Image', image_url = '') %}

<div class="flex justify-center">
  <div id="uploadContainer{{ unique_suffix }}" class="w-full max-w-md rounded-3 border-2 border-dashed border-gray-500/40 bg-dark p-6 shadow-sm transition hover:border-blue-400/70">
    <div id="uploadContent{{ unique_suffix }}" class="flex flex-col items-center justify-center cursor-pointer">

      <!-- Upload Icon & Label (Visible by default) -->
      <div id="uploadIconSection{{unique_suffix }}" class="flex flex-col items-center {{ 'hidden' if image_url else '' }}">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-primary" fill="none"
          viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M12 12V3m0 9l-3-3m3 3l3-3" />
        </svg>
        <p class="text-gray-400 mt-2">{{ label or 'Click to upload the image' }}</p>
      </div>
      <!-- Upload Icon & Label END -->

      <!-- Cropped Image Preview Section (Initially hidden) -->
      <div id="uploadedImageSection{{unique_suffix }}" class="relative w-full {{ '' if image_url else 'hidden' }}">
        <img id="uploadedImage{{unique_suffix }}" src="{{ image_url or '' }}" alt="Cropped Image" class="w-full rounded-2 border border-white/25" />
        <button id="destroyImage{{unique_suffix }}" type="button"
          class="absolute top-2 right-2 inline-flex h-8 w-8 items-center justify-center rounded-full bg-black/70 text-white hover:bg-black/85 focus:outline-none focus:ring-2 focus:ring-white/70">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <p class="mt-2 text-center text-gray-300">Image uploaded successfully. Click to change.</p>
      </div>
      <!-- Cropped Image Preview Section END -->

    </div>
  </div>
  <!-- Hidden File Input -->
  <input type="file" id="imageInput{{unique_suffix }}" accept="image/*" class="hidden">

</div>


<!-- Choice Modal -->
<div id="choiceModal{{unique_suffix }}" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
  <div class="relative w-full max-w-sm rounded-xl bg-neutral-900 shadow-2xl border border-neutral-700">
    <!-- Close Button -->
    <button id="closeChoiceModal{{unique_suffix }}" type="button" class="absolute -top-3 -right-3 p-2 rounded-full bg-white/10 text-white shadow-lg transition-transform hover:scale-105 hover:bg-white/20">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    
    <div class="p-6 pt-8 text-center">
      <!-- Modal Header -->
      <div class="mb-6">
        <h3 class="text-xl font-semibold text-white">{{ modal_title or 'Upload Photo' }}</h3>
        <p class="mt-1 text-gray-400">Choose your preferred method</p>
      </div>

      <!-- Action Buttons -->
      <div class="space-y-4">
        <button id="useCamera{{unique_suffix }}" type="button" class="w-full rounded-xl bg-blue-600 px-6 py-3.5 text-white transition-all hover:bg-blue-700 font-medium flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
          </svg>
          Take Photo
        </button>
        
        <button id="useUpload{{unique_suffix }}" type="button" class="w-full rounded-xl border border-white/10 px-6 py-3.5 text-gray-200 hover:text-white hover:border-blue-500 transition-all font-medium flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
          </svg>
          Upload Image
        </button>
      </div>
    </div>
  </div>
</div>


<!-- Cropper Modal -->
<div id="cropModal{{unique_suffix }}" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60">
  <div class="w-full max-w-2xl rounded-xl bg-neutral-900 shadow-xl border border-neutral-700">
    <!-- Cropper Container -->
    <div class="p-4">
      <div class="rounded-lg overflow-hidden bg-neutral-800">
        <img id="cropperImage{{unique_suffix }}" class="max-w-full max-h-[70vh]" alt="Image to crop">
      </div>
    </div>
    <!-- Controls for shifting & zooming -->
    <div class="flex justify-center gap-3 p-4 border-t border-neutral-700">
      <!-- Up -->
      <button id="moveUp{{unique_suffix }}" type="button" class="rounded bg-white/10 p-2 text-white hover:bg-white/20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
      </button>
      <!-- Left -->
      <button id="moveLeft{{unique_suffix }}" type="button" class="rounded bg-white/10 p-2 text-white hover:bg-white/20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <!-- Zoom Out -->
      <button id="zoomOut{{unique_suffix }}" type="button" class="rounded bg-white/10 p-2 text-white hover:bg-white/20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
        </svg>
      </button>
      <!-- Zoom In -->
      <button id="zoomIn{{unique_suffix }}" type="button" class="rounded bg-white/10 p-2 text-white hover:bg-white/20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
      </button>
      <!-- Right -->
      <button id="moveRight{{unique_suffix }}" type="button" class="rounded bg-white/10 p-2 text-white hover:bg-white/20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <!-- Down -->
      <button id="moveDown{{unique_suffix }}" type="button" class="p-2 bg-gray-100 hover:bg-gray-200 rounded">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
    </div>
    <!-- Modal Footer -->
    <div class="flex justify-end gap-3 p-4 border-t border-neutral-700">
      <button id="cancelCrop{{unique_suffix }}" type="button" class="rounded-lg border border-neutral-700 px-4 py-2 text-gray-200 hover:text-white hover:border-neutral-500">
        Cancel
      </button>
      <button id="uploadCrop{{unique_suffix }}" type="button" class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">
        Crop & Save
      </button>
    </div>
  </div>
</div>

<!-- Main Script -->
<script>

  class ImageUploader {
    constructor(uniqueId, options = {}) {
        this.id = uniqueId; // container suffix
        this.label = options.label || 'Upload Image';
        this.imageUrl = options.imageUrl || '';
        this.croppedBlob = null;
        this.imageStatus = 'unchanged'; // "unchanged", "updated", "removed"

        // DOM elements
        this.uploadContainer = document.getElementById('uploadContainer' + this.id);
        this.uploadContent = document.getElementById('uploadContent' + this.id);
        this.imageInput = document.getElementById('imageInput' + this.id);
        this.cropperImage = document.getElementById('cropperImage' + this.id);
        this.cropModal = document.getElementById('cropModal' + this.id);
        this.choiceModal = document.getElementById('choiceModal' + this.id);
        this.uploadedImage = document.getElementById('uploadedImage' + this.id);
        this.uploadedImageSection = document.getElementById('uploadedImageSection' + this.id);
        this.uploadIconSection = document.getElementById('uploadIconSection' + this.id);

        this.cropper = null;

        this._bindEvents();
    }

    _bindEvents() {
        // Open choice modal
        this.uploadContent.addEventListener('click', () => {
            this.choiceModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        });

        // Upload from file
        document.getElementById('useUpload' + this.id).addEventListener('click', () => {
            this.imageInput.removeAttribute('capture');
            this.imageInput.click();
            this.choiceModal.classList.add('hidden');
        });

        // Use camera
        document.getElementById('useCamera' + this.id).addEventListener('click', () => {
            this.choiceModal.classList.add('hidden');
            this.imageInput.setAttribute('capture', 'environment');
            this.imageInput.click();
        });

        // Close choice modal
        document.getElementById('closeChoiceModal' + this.id).addEventListener('click', () => {
            this.choiceModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });

        this.choiceModal.addEventListener('click', e => {
            if (e.target === this.choiceModal) {
                this.choiceModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        });

        // Handle file input change
        this.imageInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = event => this._showCropperModal(event.target.result);
                reader.readAsDataURL(file);
            }
        });

        // Cancel crop
        document.getElementById('cancelCrop' + this.id).addEventListener('click', () => {
            this.cropModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            if (this.cropper) {
                this.cropper.destroy();
                this.cropper = null;
            }
            this.imageInput.value = '';
        });

        // Crop & save
        document.getElementById('uploadCrop' + this.id).addEventListener('click', () => this._cropImage());

        // Destroy image
        document.getElementById('destroyImage' + this.id).addEventListener('click', () => {
            this.uploadedImageSection.classList.add('hidden');
            this.uploadIconSection.classList.remove('hidden');
            this.uploadedImage.src = '';
            this.croppedBlob = null;
            this.imageStatus = 'removed';
            this._triggerChange();
        });

        // Shift / zoom controls
        const controls = ['moveUp','moveDown','moveLeft','moveRight','zoomIn','zoomOut'];
        controls.forEach(ctrl => {
            const btn = document.getElementById(ctrl + this.id);
            if (!btn) return;
            btn.addEventListener('click', () => {
                if (!this.cropper) return;
                switch(ctrl){
                    case 'moveUp': this.cropper.move(0,10); break;
                    case 'moveDown': this.cropper.move(0,-10); break;
                    case 'moveLeft': this.cropper.move(10,0); break;
                    case 'moveRight': this.cropper.move(-10,0); break;
                    case 'zoomIn': this.cropper.zoom(0.1); break;
                    case 'zoomOut': this.cropper.zoom(-0.1); break;
                }
            });
        });
    }

    _showCropperModal(imageSrc) {
        this.cropperImage.src = imageSrc;
        this.cropModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

        if (this.cropper) this.cropper.destroy();
        this.cropper = new Cropper(this.cropperImage, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1,
            guides: false,
            background: false,
            movable: true,
            zoomable: true,
            rotatable: false,
            scalable: false,
        });
    }

    _cropImage() {
        if (!this.cropper) return;
        const canvas = this.cropper.getCroppedCanvas({ width: 512, height: 512, fillColor: '#fff', imageSmoothingQuality: 'high' });
        canvas.toBlob(blob => {
            this.croppedBlob = blob;
            this.uploadedImage.src = URL.createObjectURL(blob);
            this.uploadedImageSection.classList.remove('hidden');
            this.uploadIconSection.classList.add('hidden');
            this.imageStatus = 'updated';
            this.cropModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            this.cropper.destroy();
            this.cropper = null;
            this.imageInput.value = '';
            this._triggerChange();
        }, 'image/jpeg', 1);
    }


    // Register callback for main code
    onChange(callback) { this._changeCallback = callback; }

    _triggerChange() { if (this._changeCallback) this._changeCallback(this.croppedBlob, this.imageStatus); }

    getBlob() { return this.croppedBlob; }
    getStatus() { return this.imageStatus; }
}

</script>

{% endmacro %}