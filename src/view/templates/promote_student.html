{% extends "base.html" %} {% block title %}Students Data{% endblock %} {% block
content %}

<style>
    .promotion-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(0, 420px));
        gap: 16px;
        /* space between cards */
        justify-content: center;
        /* leftover space only on sides */
        align-items: start;
        width: 100%;
        box-sizing: border-box;
    }

    /* On very small screens (phones), force 1 card per row */
    @media (max-width: 480px) {
        .spromotion-cards {
            grid-template-columns: 1fr;
            /* single column full width */
        }
    }

    /* Card styling */
    .student-image {
        border: 3px solid #8f94fb;
        object-position: top;
        object-fit: cover;
        display: block;
        width: 120px;
        height: 160px;
    }

    .card-hover {
        transition: all 0.3s ease;
        background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #333;
    }

    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        border-color: #4e54c8;
    }

    .modal {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .modal-hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.9);
    }

    .modal-visible {
        opacity: 1;
        pointer-events: auto;
        transform: scale(1);
    }


    /* âœ… Hide scrollbar but allow scroll for modal*/
    .hide-scrollbar {
        scrollbar-width: none;
        /* Firefox */
        -ms-overflow-style: none;
        /* IE & Edge */
    }

    .hide-scrollbar::-webkit-scrollbar {
        display: none;
        /* Chrome, Safari */
    }
</style>


<div class="container" id="student-container">

    <!-- Page Header -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-green-400 ">Student Promotion Portal</h1>
            <p class="text-gray-400 mt-1 md:mt-2 text-sm md:text-base">Manage student promotions to the next academic
                session with
                an intuitive interface</p>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="flex flex-col gap-3 mb-6 md:mb-10">
        <!-- Search Box -->
        <div class="p-3 rounded-lg md:rounded-xl bg-[#1e1e1e]">
            <div class="flex items-center">
                <i class="fas fa-search text-gray-500 mr-3"></i>
                <input type="text" id="search-input" oninput="applyFilters()"
                    placeholder="Search by name or roll number..."
                    class="w-full bg-transparent border-0 text-white placeholder-gray-500 focus:outline-none text-sm md:text-base">
            </div>
        </div>

        <!-- Dropdown -->
        <div class="relative">
            <div class="flex items-center p-3 rounded-lg md:rounded-xl bg-[#1e1e1e]">
                <!-- Left Icon -->
                <i class="fas fa-layer-group text-gray-500 mr-3"></i>

                <!-- Select -->
                <select id="classView"
                    onchange="updatePage('/get_prv_year_students_api', 'StudentData', { 'class_id': event.target.value });"
                    class="w-full appearance-none cursor-pointer text-gray-400 text-sm md:text-base bg-transparent focus:outline-none pr-8">
                    <option class="bg-[#1e1e1e] text-white" selected hidden value="">Select Class</option>
                    {% if classes %}
                    {% for class in classes %}
                    <option class="bg-[#1e1e1e] text-white" value="{{ class.id }}">{{ class.CLASS }}</option>
                    {% endfor %}
                    {% endif %}
                </select>
            </div>

            <!-- Right Chevron -->
            <i
                class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
        </div>

    </div>

    <div class="promotion-cards" id="StudentData">
        {% if not data %}
        <div class="col-span-full">
            <div class="flex flex-col items-center justify-center text-center bg-gray-800 rounded-2xl p-6 shadow-lg">
                <i class="fas fa-info-circle text-blue-400 text-4xl mb-3"></i>
                <h3 class="text-xl font-semibold text-white mb-1">No Students Loaded</h3>
                <p class="text-gray-400">Please select a class to view the student list.</p>
            </div>
        </div>
        {% endif %}



        {% for row in data %}
        <div class="student-card rounded-2xl overflow-hidden shadow-lg card-hover" data-name="{{ row.STUDENTS_NAME }}"
            data-class="{{ row.previous_class }}" data-father="{{ row.FATHERS_NAME }}" data-PEN="{{ row.PEN }}"
            data-roll="{{ row.previous_roll }}" data-phone="{{ row.PHONE }}">

            <div class="p-6">
                <div class="flex items-start gap-3">
                    <img src="{% if row.IMAGE %}
                        {{ 'https://lh3.googleusercontent.com/d/' + row.IMAGE + '=s200' }}
                        {% else %}
                            {{ url_for('static', filename=('no-student-boy-image.png' if row.GENDER == 'Male' else 'no-student-girl-image.png')) }}
                        {% endif %}" alt="Student Image" class="student-image mt-2" loading="lazy">

                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-lg text-green-400 truncate">{{ row.STUDENTS_NAME }}</h3>
                        <p class="text-sm text-gray-400">
                            <span class="font-medium">C/O:</span> {{ row.FATHERS_NAME }}
                        </p>

                        <div class="mt-3 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Old Class:</span>
                                <span class="font-medium text-white">{{ row.previous_class }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Old Roll No:</span>
                                <span class="font-medium text-white">{{ row.previous_roll }}</span>
                            </div>
                            {% if row.next_class %}
                            <div class="flex justify-between text-green-300">
                                <span>Next Class:</span>
                                <span class="font-medium">{{ row.next_class }}</span>
                            </div>
                            {% endif %}
                            {% if row.promoted_session_id %}
                            <div class="flex justify-between text-green-300">
                                <span>Next Roll No:</span>
                                <span class="font-medium">{{ row.next_roll }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>


                <div class="mt-6 flex gap-3">
                    {% if row.promoted_session_id %}
                    <button
                        class="update-btn flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-medium transition-colors flex items-center justify-center"
                        onclick="updateStudentModal('{{ row.promoted_session_id }}')">
                        <i class="fas fa-edit mr-2"></i> Update
                    </button>
                    <button
                        class="depromote-btn flex-1 bg-red-700 hover:bg-red-600 text-white py-2 rounded-lg font-medium transition-colors flex items-center justify-center"
                        onclick="depromoteStudentModal('{{ row.promoted_session_id }}')">
                        <i class="fas fa-times-circle mr-2"></i> Depromote
                    </button>
                    {% else %}
                    <button
                        class="promote-btn mt-2 flex-1 bg-green-700 hover:bg-green-600 text-white py-2 rounded-lg font-medium transition-colors flex items-center justify-center"
                        onclick="promoteStudentModal('{{ row.id }}')" {% if not row.next_class %} disabled
                        style="opacity: 0.6; cursor: not-allowed;" {% endif %}>
                        <i class="fas fa-graduation-cap mr-2"></i> {% if not row.next_class %}No Classes{% else %}
                        Promote {% endif %}
                    </button>

                    <button
                        class="tc-btn mt-2 flex-1 bg-yellow-700 hover:bg-yellow-600 text-white py-2 rounded-lg font-medium transition-colors flex items-center justify-center"
                        onclick="CreateTCModal('{{ row.id }}')">
                        <i class="fa fa-file-text mr-2"></i> Create TC
                    </button>
                    {% endif %}
                </div>

            </div>
        </div>

        {% endfor %}
    </div>
</div>

<!-- No Results Section (Initially Hidden) -->
<div id="noResults" class="no-results hidden mt-16 text-center">
    <div class="bg-gray-800 rounded-2xl p-10 border border-gray-700 max-w-2xl mx-auto">
        <i class="fas fa-search text-5xl text-gray-500 mb-4"></i>
        <h3 class="text-2xl font-bold text-gray-300 mb-2">No Students Found</h3>
        <p class="text-gray-500">Try adjusting your search or filter criteria to find what you're looking for.</p>
    </div>
</div>

<!-- Student Promotion Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity backdrop-blur-sm z-50 flex items-center justify-center p-4 modal-hidden"
    id="studentPromotionModal">
    <div class="bg-gray-800 rounded-lg w-full max-w-md shadow-2xl max-h-[90vh] flex flex-col" id="modalContent">

        <!-- Modal Header -->
        <div class="relative bg-blue-600 p-4 rounded-t-lg flex items-center justify-center">
            <i class="fas fa-school text-white text-xl mr-2"></i>
            <h5 class="text-white text-xl font-bold" id="modalTitle">Promote Student</h5>

            <!-- Close button -->
            <button type="button"
                class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-200 text-xl"
                id="closeModal">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body (scrollable, scrollbar hidden) -->
        <div class="flex-1 overflow-y-auto px-6 py-5 hide-scrollbar">
            <form id="promotionForm" class="px-6">
                <!-- Student Image and Name -->
                <div class="flex flex-col items-center mb-3">
                    <img id="studentImage" src="" alt="Student Image" class="student-image w-32 h-32 rounded-full mb-2" loading="lazy">

                    <h3 id="studentName" data-id="" class="text-2xl font-bold text-white text-center"></h3>
                    <p id="father" class="text-gray-400 text-center"></p>
                </div>

                <!-- Details Table -->
                <div class="bg-gray-700 rounded-xl p-4 mb-5">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                            <span class="text-gray-300 font-medium">Old Class</span>
                            <span id="oldClass" class="text-white font-semibold"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300 font-medium">New Class</span>
                            <span id="newClass" class="text-accent-green font-semibold"></span>
                        </div>
                    </div>
                </div>

                <!-- Input Fields -->
                <div class="space-y-4">
                    <div>
                        <label for="newRoll" class="block text-gray-300 mb-2 font-medium">New Roll Number <span
                                class="text-red-400">*</span></label>
                        <input type="number" inputmode="numeric" id="newRoll" name="newRoll" required
                            class="w-full bg-gray-700  rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200"
                            placeholder="Enter new roll number">
                        <p id="newRollError" class="error-message hidden" style="color: red;"></p>
                    </div>

                    <div>
                        <label for="due" class="block text-gray-300 mb-2 font-medium">Due Amount</label>
                        <input type="number" inputmode="numeric" id="due" name="due" min="0" step="0.01"
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200"
                            placeholder="Enter due amount (if any)">
                        <p id="dueError" class="error-message hidden" style="color: red;"></p>
                    </div>

                    <div>
                        <label for="promotion_date" class="block text-gray-300 mb-2 font-medium">Promotion Date <span
                                class="text-red-400">*</span></label>
                        <input type="date" id="promotion_date" name="promotion_date" required
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200">
                        <p id="dateError" class="error-message hidden" style="color: red;"></p>
                    </div>

                    <div class="hidden pt-2" id="depromoteCheckboxContainer">
                        <div class="flex items-start">
                            <input
                                class="form-check-input mt-1 mr-3 w-5 h-5 text-red-500 bg-gray-700 border-gray-600 rounded focus:ring-red-500"
                                type="checkbox" id="depromoteCheckbox">
                            <div>
                                <label class="text-red-300 font-medium" for="depromoteCheckbox">
                                    Depromote Student, Due amount will also be cleared.
                                </label>
                                <p class="text-red-400 text-sm mt-1">
                                    <strong>This action cannot be undone.</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!-- Modal Footer -->
        <div class="bg-gray-700 rounded-b-lg border-t border-gray-600 px-6 py-3 flex flex-wrap gap-3 justify-between">

            <!-- Close button on the left -->
            <div>
                <button type="button"
                    class="px-3 py-2.5 bg-gray-600 hover:bg-gray-500 text-white rounded-xl font-medium transition-colors duration-200"
                    onclick="closeModal()">
                    <i class="fas fa-times mr-2"></i>
                    Close
                </button>
            </div>

            <!-- Action buttons on the right -->
            <div class="flex flex-wrap gap-3" id="modal-footer">

                <button type="button"
                    class="px-4 py-2.5 bg-green-600 hover:bg-green-500 text-white rounded-xl font-medium transition-colors duration-200 flex items-center"
                    id="promoteButton">
                    <span id="promoteSpinner"
                        class="spinner-border hidden h-4 w-4 mr-2 border-2 border-t-transparent rounded-full"></span>
                    <i class="fas fa-check-circle mr-2"></i>
                    Promote
                </button>

                <button type="button"
                    class="px-4 py-2.5 bg-red-600 hover:bg-red-500 text-white rounded-xl font-medium transition-colors duration-200 hidden"
                    id="depromoteButton">
                    <span id="depromoteSpinner"
                        class="spinner-border hidden h-4 w-4 mr-2 border-2 border-t-transparent rounded-full"></span>
                    <i class="fas fa-times-circle mr-2"></i>
                    Depromote
                </button>

                <button type="button"
                    class="px-4 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-medium transition-colors duration-200 hidden"
                    id="updateButton">
                    <span id="updateSpinner"
                        class="spinner-border hidden h-4 w-4 mr-2 border-2 border-t-transparent rounded-full"></span>
                    <i class="fas fa-sync-alt mr-2"></i>
                    Update
                </button>

                <button type="button"
                    class="px-4 py-2.5 bg-green-600 hover:bg-green-500 text-white rounded-xl font-medium transition-colors duration-200 hidden"
                    id="messageButton">
                    <i class="fas fa-whatsapp mr-2"></i>
                    Send Message
                </button>
            </div>

        </div>

    </div>
</div>

<!-- Student TC generation Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity backdrop-blur-sm z-50 flex items-center justify-center p-4 modal-hidden"
    id="studenttcModal">
    <div class="bg-gray-800 rounded-lg w-full max-w-md shadow-2xl max-h-[90vh] flex flex-col" id="tc-modalContent">

        <!-- Modal Header -->
        <div class="relative bg-blue-600 p-4 rounded-t-lg flex items-center justify-center">
            <i class="fas fa-school text-white text-xl mr-2"></i>
            <h5 class="text-white text-xl font-bold" id="tc-modalTitle"></h5>
            <button type="button"
                class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-200 text-xl"
                id="tc-closeModal" onclick="closeTCModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body (scrollable, scrollbar hidden) -->
        <div class="flex-1 overflow-y-auto px-6 py-5 hide-scrollbar">
            <form id="promotionForm" class="px-6">
                <!-- Student Image and Name -->
                <div class="flex flex-col items-center mb-3">
                    <img id="studentImageTC" src="" alt="Student Image"
                        class="student-image w-32 h-32 rounded-full mb-2" loading="lazy">

                    <h3 id="studentNameTC" data-id="" class="text-2xl font-bold text-white text-center"></h3>
                    <p id="fatherNameTC" class="text-gray-400 text-center"></p>
                </div>

                <!-- Details Table -->
                <div class="bg-gray-700 rounded-xl p-4 mb-5">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                            <span class="text-gray-300 font-medium">Old Class</span>
                            <span id="oldClassTC" class="text-white font-semibold">10-B (Roll No: 08)</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300 font-medium">New Class</span>
                            <span id="newClassTC" class="text-accent-green font-semibold">11-B</span>
                        </div>
                    </div>
                </div>

                <!-- Input Fields -->
                <div class="space-y-4">
                    <div>
                        <label for="leavingReason" class="block text-gray-300 mb-2 font-medium">Leaving Reason <span
                                class="text-red-400">*</span></label>
                        <input type="text" id="leavingReason" name="leavingReason" required
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200"
                            placeholder="Enter leaving reason" list="leavingReasonList">
                        <datalist id="leavingReasonList">
                            <option value="Completed the studies"></option>
                            <option value="Parent's Wish"></option>
                            <option value="Transfer to another school"></option>
                            <option value="Due to Relocation"></option>
                            <option value="Due to Financial reasons"></option>
                        </datalist>
                        <p id="leavingReasonError" class="error-message hidden" style="color: red;"></p>
                    </div>

                    <div>
                        <label for="generalConduct" class="block text-gray-300 mb-2 font-medium">General Conduct <span
                                class="text-red-400">*</span></label>
                        <input type="text" id="generalConduct" name="generalConduct" required
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200"
                            placeholder="Enter general conduct" list="generalConductList">
                        <datalist id="generalConductList">
                            <option value="Very Good"></option>
                            <option value="Excellent"></option>
                            <option value="Good"></option>
                            <option value="Satisfactory"></option>
                            <option value="Needs Improvement"></option>
                        </datalist>
                        <p id="generalConductError" class="error-message hidden" style="color: red;"></p>
                    </div>

                    <div>
                        <label for="leavingDate" class="block text-gray-300 mb-2 font-medium">Leaving Date <span
                                class="text-red-400">*</span></label>
                        <input type="date" id="leavingDate" name="leavingDate" required
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200">
                        <p id="dateError" class="error-message hidden" style="color: red;"></p>
                    </div>


                    <div>
                        <label for="otherRemark" class="block text-gray-300 mb-2 font-medium">Any Remarks?</label>
                        <input type="text" id="otherRemark" name="otherRemark"
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200"
                            placeholder="Enter any remark (if any)">
                        <p id="otherRemarkError" class="error-message hidden" style="color: red;"></p>
                    </div>
                </div>
            </form>
        </div>
        <!-- Modal Footer -->
        <div class="bg-gray-700 rounded-b-lg border-t border-gray-600 px-6 py-3 flex flex-wrap gap-3 justify-between">

            <!-- Close button on the left -->
            <div>
                <button type="button"
                    class="px-3 py-2.5 bg-gray-600 hover:bg-gray-500 text-white rounded-xl font-medium transition-colors duration-200"
                    onclick="closeTCModal()">
                    <i class="fas fa-times mr-2"></i>
                    Close
                </button>
            </div>

            <!-- Action buttons on the right -->
            <div class="flex flex-wrap gap-3" id="tc-modal-footer">
                <button type="button"
                    class="px-4 py-2.5 bg-green-600 hover:bg-green-500 text-white rounded-xl font-medium transition-colors duration-200 hidden"
                    id="tc-messageButton">
                    <i class="fas fa-whatsapp mr-2"></i>
                    Send Message
                </button>

                <button type="button"
                    class="px-4 py-2.5 bg-green-600 hover:bg-green-500 text-white rounded-xl font-medium transition-colors duration-200"
                    id="tc-generateButton">
                    <i class="fas fa-arrow-right mr-2"></i>
                    Generate TC
                </button>
            </div>
        </div>

    </div>
</div>



<script src="{{ url_for('static', filename='watsappMessage.js') }}"></script>
<script>



    async function promoteStudentModal(studentID) {

        try {
            const res = await fetch('/student_data_modal_api', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 'student_id': studentID }),
            });

            const data = await res.json();

            if (res.ok) {
                //Verify the data before sending the request
                document.getElementById("modalTitle").innerHTML = "Promote Student";
                document.getElementById("studentName").innerHTML = data.STUDENTS_NAME;
                document.getElementById("studentName").setAttribute("data-id", data.id);
                document.getElementById("oldClass").innerHTML = data.CLASS + " | Roll: " + data.ROLL;
                document.getElementById("newClass").innerHTML = data.promoted_class;
                document.getElementById("newRoll").value = data.promoted_roll;
                document.getElementById("promotion_date").value = data.promoted_date;
                document.getElementById("father").innerHTML = data.FATHERS_NAME;
                document.getElementById("due").value = data.due_amount;

                if (data.IMAGE) {
                    document.getElementById("studentImage").src = 'https://lh3.googleusercontent.com/d/' + data.IMAGE + '=s200';
                } else {
                    document.getElementById("studentImage").src = 'https://cdn.pixabay.com/photo/2016/04/22/04/57/graduation-1345143_1280.png';
                }

                const footer = document.getElementById("modal-footer");

                footer.querySelector("#messageButton").classList.add("hidden");
                footer.querySelector('#updateButton')?.classList.add("hidden");
                footer.querySelector('#depromoteButton')?.classList.add("hidden");
                document.getElementById('depromoteCheckboxContainer').classList.add('hidden');

                promoteButton = footer.querySelector("#promoteButton");
                promoteButton.setAttribute("onclick", `finalPromote('${data.id}')`);
                promoteButton.classList.remove("hidden");
                promoteButton.disabled = false;

                // Show modal and prevent background scrolling
                openPromotionModal()

            } else {
                showAlert(res.status, data.message);
            }

        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        }
    }

    async function updateStudentModal(studentSessionID) {

        try {
            const res = await fetch('/promoted_student_modal_api', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 'studentSessionID': studentSessionID }),
            });

            const data = await res.json();

            if (res.ok) {

                //Verify the data before sending the request
                document.getElementById("modalTitle").innerHTML = "Update Student";
                document.getElementById("studentName").innerHTML = data.STUDENTS_NAME;
                document.getElementById("studentName").setAttribute("data-id", data.id);
                document.getElementById("oldClass").innerHTML = data.CLASS + " | Roll: " + data.ROLL;
                document.getElementById("newClass").innerHTML = data.promoted_class;
                document.getElementById("newRoll").value = data.promoted_roll;
                document.getElementById("promotion_date").value = data.promoted_date;
                document.getElementById("father").innerHTML = data.FATHERS_NAME;
                document.getElementById("due").value = data.due_amount;

                if (data.IMAGE) {
                    document.getElementById("studentImage").src = 'https://lh3.googleusercontent.com/d/' + data.IMAGE + '=s200';
                } else {
                    document.getElementById("studentImage").src = 'https://cdn.pixabay.com/photo/2016/04/22/04/57/graduation-1345143_1280.png';
                }

                // Enable required buttons

                const footer = document.getElementById("modal-footer");

                messageButton = footer.querySelector("#messageButton");
                messageButton.classList.add("hidden");
                messageButton.disabled = true;

                promoteButton = footer.querySelector('#promoteButton');
                promoteButton.classList.add("hidden");
                promoteButton.disabled = true;

                depromoteButton = footer.querySelector('#depromoteButton');
                depromoteButton.classList.add("hidden");
                depromoteButton.disabled = true;

                document.getElementById('depromoteCheckboxContainer').classList.add('hidden');

                const updateButton = footer.querySelector("#updateButton");
                updateButton.setAttribute("onclick", `finalUpdate('${data.promoted_session_id}')`);
                updateButton.classList.remove("hidden");
                updateButton.disabled = false;

                // Show modal and prevent background scrolling
                openPromotionModal();

            } else {
                showAlert(res.status, data.message);
            }

        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        }

    }

    async function depromoteStudentModal(studentSessionID) {

        try {
            const res = await fetch('/promoted_student_modal_api', {   //same api is used which we have used in promoted_student_modal_api.py
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 'studentSessionID': studentSessionID }),
            });

            const data = await res.json();

            if (res.ok) {

                //Verify the data before sending the request
                document.getElementById("modalTitle").innerHTML = "Depromote Student";
                document.getElementById("studentName").innerHTML = data.STUDENTS_NAME;
                document.getElementById("studentName").setAttribute("data-id", data.id);
                document.getElementById("oldClass").innerHTML = data.CLASS + " | Roll: " + data.ROLL;
                document.getElementById("newClass").innerHTML = data.promoted_class;
                document.getElementById("father").innerHTML = data.FATHERS_NAME;

                document.getElementById("newRoll").value = data.promoted_roll;
                document.getElementById("newRoll").disabled = true;
                document.getElementById("promotion_date").value = data.promoted_date;
                document.getElementById("promotion_date").disabled = true;
                document.getElementById("due").disabled = true;
                if (data.due_amount) {
                    document.getElementById("due").value = data.due_amount;
                } else {
                    document.getElementById("due").value = 0;
                }

                if (data.IMAGE) {
                    document.getElementById("studentImage").src = 'https://lh3.googleusercontent.com/d/' + data.IMAGE + '=s200';
                } else {
                    document.getElementById("studentImage").src = 'https://cdn.pixabay.com/photo/2016/04/22/04/57/graduation-1345143_1280.png';
                }

                const footer = document.getElementById("modal-footer");
                footer.querySelector("#messageButton").classList.add("hidden");
                footer.querySelector('#promoteButton')?.classList.add("hidden");
                footer.querySelector('#updateButton')?.classList.add("hidden");

                document.getElementById('depromoteCheckboxContainer').classList.remove('hidden');
                const depromoteButton = footer.querySelector("#depromoteButton");
                depromoteButton.setAttribute("onclick", `finalDepromote('${data.promoted_session_id}')`);
                depromoteButton.classList.remove("hidden");
                depromoteButton.disabled = false;


                // Show modal
                openPromotionModal();

            } else {
                showAlert(res.status, data.message);
            }

        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        }
    }


    async function CreateTCModal(studentID) {

        try {
            const res = await fetch('/student_data_modal_api', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 'student_id': studentID }),
            });

            const data = await res.json();

            if (res.ok) {
                //Verify the data before sending the request
                document.getElementById("tc-modalTitle").innerHTML = "Generate TC";
                document.getElementById("studentNameTC").innerHTML = data.STUDENTS_NAME;
                document.getElementById("studentNameTC").setAttribute("data-id", data.id);
                document.getElementById("leavingDate").value = data.promoted_date;
                document.getElementById("oldClassTC").innerHTML = data.CLASS + " | Roll: " + data.ROLL;
                document.getElementById("newClassTC").innerHTML = data.promoted_class;
                document.getElementById("fatherNameTC").innerHTML = data.FATHERS_NAME;

                if (data.IMAGE) {
                    document.getElementById("studentImageTC").src = 'https://lh3.googleusercontent.com/d/' + data.IMAGE + '=s200';
                } else {
                    document.getElementById("studentImageTC").src = 'https://cdn.pixabay.com/photo/2016/04/22/04/57/graduation-1345143_1280.png';
                }

                const tc_modal_footer = document.getElementById("tc-modal-footer");
                tc_modal_footer.querySelector("#tc-messageButton").classList.add("hidden");
                tc_modal_footer.querySelector("#tc-generateButton").classList.remove("hidden");

                generateTCButton = tc_modal_footer.querySelector("#tc-generateButton");
                generateTCButton.addEventListener("click", () => {
                    const leavingReason = document.getElementById("leavingReason").value;
                    const leavingDate = document.getElementById("leavingDate").value;
                    const generalConduct = document.getElementById("generalConduct").value;
                    const otherRemarks = document.getElementById("otherRemark").value;
                    generateTC(data.id, leavingReason, leavingDate, generalConduct, otherRemarks);
                });

                // Show modal and prevent background scrolling
                const modal = document.getElementById('studenttcModal');
                modal.classList.remove("modal-hidden");
                document.body.style.overflow = "hidden"; // ðŸš« lock background scroll

            } else {
                showAlert(res.status, data.message);
            }

        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        }
    }


    async function finalPromote(studentID) {

        const form = document.getElementById("promotionForm");
        const formData = new FormData(form);

        const btn = document.getElementById("promoteButton");
        const spinner = document.getElementById("promoteSpinner");

        btn.disabled = true;
        spinner.classList.remove("d-none");

        const promoted_date = formData.get("promotion_date");
        const promoted_roll = formData.get("newRoll");
        const due_amount = formData.get("due");

        try {
            const res = await fetch("/final_promotion_api", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    'student_id': studentID, 'promoted_date': promoted_date,
                    'promoted_roll': promoted_roll, 'due_amount': due_amount
                }),
            });

            const data = await res.json();

            if (res.ok) {

                const response = await fetch('/generate_watsapp_message_api', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 'student_id': studentID }),
                });

                const generate_message = await response.json();

                if (generate_message.PHONE && generate_message.whatsappMessage && response.ok) {

                    const footer = document.getElementById("modal-footer");
                    const messageButton = document.getElementById("messageButton");
                    const phone = document.getElementById("messageButton").getAttribute("data-phone");

                    footer.querySelector('#promoteButton')?.classList.add("hidden");
                    footer.querySelector('#updateButton')?.classList.add("hidden");
                    footer.querySelector('#depromoteButton')?.classList.add("hidden");
                    document.getElementById('depromoteCheckboxContainer').classList.add('hidden');

                    console.log("WhatsApp message generated successfully.");

                    messageButton.setAttribute("onclick", `sendWhatsAppMessage('${generate_message.PHONE}', \`${generate_message.whatsappMessage}\`)`);
                    messageButton.classList.remove("hidden");
                    messageButton.disabled = false;
                }
                else {
                    console.log("WhatsApp message not generated successfully.");
                    closeModal()
                }
            }
            showAlert(res.status, data.message);

        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        } finally {
            spinner.classList.add("d-none");
            btn.disabled = false;
        }
    }

    async function finalUpdate(studentSessionID) {

        const form = document.getElementById("promotionForm");
        const formData = new FormData(form);

        const btn = document.getElementById("promoteButton");
        const spinner = document.getElementById("promoteSpinner");

        btn.disabled = true;
        spinner.classList.remove("d-none");

        const promoted_date = formData.get("promotion_date");
        const promoted_roll = formData.get("newRoll");
        const due_amount = formData.get("due");

        try {
            const res = await fetch("/final_update_api", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    'student_session_ID': studentSessionID, 'promoted_date': promoted_date,
                    'promoted_roll': promoted_roll, 'due_amount': due_amount
                }),
            });

            const data = await res.json();

            if (res.ok) {
                closeModal()
            }

            showAlert(res.status, data.message);

        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        } finally {
            spinner.classList.add("d-none");
            btn.disabled = false;
        }
    }

    async function finalDepromote(studentSessionID) {

        const isChecked = document.getElementById('depromoteCheckbox').checked;
        if (!isChecked) {
            showAlert(400, "Please check the checkbox to confirm depromotion.");
            return;
        }

        const form = document.getElementById("promotionForm");
        const formData = new FormData(form);

        const btn = document.getElementById("depromoteButton");
        const spinner = document.getElementById("depromoteSpinner");

        btn.disabled = true;
        spinner.classList.remove("d-none");

        try {
            const res = await fetch("/final_depromotion_api", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 'student_session_id': studentSessionID }),
            });

            const data = await res.json();

            if (res.ok) {
                closeModal();
            }
            showAlert(res.status, data.message);

        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        } finally {
            spinner.classList.add("d-none");
            btn.disabled = false;
        }
    }




    async function generateTC(studentId, leavingReason, leavingDate, generalConduct, otherRemarks = "") {

        if (!leavingReason) {
            showAlert(400, "Please select a reason for leaving.");
            return;
        }
        if (!leavingDate) {
            showAlert(400, "Please select a leaving date.");
            return;
        }
        if (!generalConduct) {
            showAlert(400, "Please provide general conduct remarks.");
            return;
        }

        try {
            // 1. Send the request
            const resp = await fetch("/generate_tc_form_api", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    student_id: studentId,
                    leavingReason: leavingReason,
                    leavingDate: leavingDate,
                    generalConduct: generalConduct,
                    otherRemarks: otherRemarks
                }),
            });

            // 2. Get the HTML text
            const content = await resp.json();

            if (!resp.ok) {
                showAlert(resp.status, content.message);
                console.error(`Server error: ${content.message}`);
                return;
            }

            // 3. Open a new window/tab
            const printWindow = window.open("", "_blank");

            if (!printWindow) {
                showAlert(400, "Unable to open print window");
                throw new Error("Unable to open print window");
            }

            // 4. Write the HTML into the new window
            printWindow.document.open();
            printWindow.document.write(content.html);
            printWindow.document.close();

            // 5. Wait for resources (CSS/images) to load, then print
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
            };
        } catch (err) {
            console.error(err);
        }
    }

    // Form validation function
    function validateForm() {
        let isValid = true;

        // Error messages
        let newRollError = document.getElementById('newRollError');
        let dueError = document.getElementById('dueError');
        let dateError = document.getElementById('dateError');

        // Reset error states
        newRoll.classList.remove('input-error');
        due.classList.remove('input-error');
        promotionDate.classList.remove('input-error');
        newRollError.style.display = 'none';
        dueError.style.display = 'none';
        dateError.style.display = 'none';

        // Validate new roll number
        if (!newRoll.value || isNaN(newRoll.value) || newRoll.value <= 0) {
            newRoll.classList.add('input-error');
            newRollError.style.display = 'block';
            isValid = false;
        }

        // Validate due amount (optional)
        if (due.value && (isNaN(due.value) || due.value < 0)) {
            due.classList.add('input-error');
            dueError.style.display = 'block';
            isValid = false;
        }

        // Validate promotion date
        if (!promotionDate.value) {
            promotionDate.classList.add('input-error');
            dateError.style.display = 'block';
            isValid = false;
        }

        return isValid;
    }


    // Example: function to open modal
    function openPromotionModal() {
        const modal = document.getElementById('studentPromotionModal');
        modal.classList.remove("modal-hidden");
        document.body.style.overflow = "hidden"; // ðŸš« lock background scroll
    }

    function closeModal() {
        const modal = document.getElementById('studentPromotionModal');
        modal.classList.add("modal-hidden");
        document.body.style.overflow = ""; // âœ… restore scroll

        // we disable the form elements in de-promotion modal, enable them after closing
        document.getElementById("promotionForm").reset();
        document.getElementById("newRoll").disabled = false;
        document.getElementById("due").disabled = false;
        document.getElementById("promotion_date").disabled = false;
    }

    function closeTCModal() {
        const modal = document.getElementById('studenttcModal');
        modal.classList.add("modal-hidden");
        document.body.style.overflow = ""; // âœ… restore scroll
    }

    document.getElementById('closeModal').addEventListener("click", closeModal);

    // Click outside modal closes it
    document.getElementById('studentPromotionModal').addEventListener("click", (e) => {
        if (!document.getElementById('modalContent').contains(e.target)) {
            closeModal();
        }
    });

    function applyFilters() {
        const term = document
            .getElementById("search-input")
            .value.trim()
            .toLowerCase();

        console.log("Search Term:", term);

        // Grab all student cards
        const cards = document.querySelectorAll(".student-card");

        cards.forEach((card) => {
            // Read the relevant data attributes
            const name = card.getAttribute("data-name").toLowerCase();
            const roll = card.getAttribute("data-roll").toLowerCase();

            // Check if any field contains the search term
            const matches = name.includes(term) || roll.includes(term);

            // Show/hide card
            card.style.display = matches ? "" : "none";
        });
    }

    document.getElementById("classView").addEventListener("change", () => {
        document.getElementById("search-input").value = "";
        applyFilters();
    });
</script>

{% endblock %}