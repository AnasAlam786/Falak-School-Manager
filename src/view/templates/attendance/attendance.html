{% extends "base.html" %}
{% block title %}Attendance Management{% endblock %}
{% block content %}
<style>
    .present-option.selected {
        background-image: linear-gradient(to bottom right, #22c55e, #10b981); /* green example */
        color: rgb(255, 255, 255);
        transform: scale(1.03);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .absent-option.selected {
        background-image: linear-gradient(to bottom right, #ef4444, #ef4444); /* green example */
        color: rgb(255, 255, 255);
        transform: scale(1.03);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .halfDay-option.selected {
        background-image: linear-gradient(to bottom right, #f59e0b, #f59e0b); /* green example */
        color: rgb(255, 255, 255);
        transform: scale(1.03);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .attendance-option.loading-active {
        opacity: 0.8;
        transition: opacity 0.2s ease-in-out;
    }

    .loader-spin {
        animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to   { transform: rotate(360deg); }
    }


</style>



<!-- Main Container -->
<div class="mx-auto">

    <!-- Page Header -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-white">Attendance Management System</h1>
            <p class="text-gray-400 mt-1 md:mt-2 text-sm md:text-base">
                Efficiently track and manage student attendance with our modern, intuitive interface
            </p>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col md:flex-row gap-3 mt-4 md:mt-0">
            <!-- Add New Student -->
            <button id="holidayBtn"
                class="bg-gradient-to-r from-blue-500 to-indigo-700 text-white px-6 py-3 rounded-xl font-medium flex items-center justify-center">
                <i class="fas fa-plus mr-2"></i> Mark Holiday
            </button>
        </div>
    </div>

    <!-- Modern Filters & Actions Section -->
    <section class="w-full mb-10 p-6 bg-gradient-to-br from-[#1A1A1A] to-[#202020] rounded-2xl shadow-2xl border border-[#2A2A2A]">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
            <!-- Class Selector -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-3">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-500/20 rounded-lg mr-2">
                            <i class="fas fa-users text-blue-400"></i>
                        </div>
                        <span>Select Class</span>
                    </div>
                </label>
                <div class="relative group">
                    <select class="w-full bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl py-3.5 px-4 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 group-hover:border-gray-500" id="classSelector">
                        {% if classes %}
                        {% for class in classes %}
                            <option value="{{ class.id }}">{{ class.CLASS }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400">
                        <i class="fas fa-chevron-down transition-transform duration-300 group-hover:translate-y-0.5"></i>
                    </div>
                </div>
            </div>

            <!-- Date Selector -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-3">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-500/20 rounded-lg mr-2">
                            <i class="far fa-calendar-alt text-blue-400"></i>
                        </div>
                        <span>Select Date</span>
                    </div>
                </label>
                <div class="relative group">
                    <input type="date" id="dateSelector" value="{{ current_date }}" class="w-full bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl py-3.5 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 group-hover:border-gray-500 [color-scheme:dark]">
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400"></div>
                </div>
            </div>

            <!-- Get Attendance Button -->
            <div class="lg:col-span-2 flex justify-center mt-6 w-full">
                <button id="getAttendanceDataBTN" class="w-full lg:w-1/2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-medium py-3.5 px-6 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center group">
                    <div class="flex items-center justify-center">
                        <div class="p-1.5 bg-white/20 rounded-lg mr-3 group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-calendar-plus text-white"></i>
                        </div>
                        <span class="font-semibold">Get Attendance</span>
                    </div>
                </button>
            </div>
        </div>
    </section>

    <!-- Attendance Cards Section -->
    <section class="mb-10">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">Student Attendance:</h2>
            <div class="text-sm text-gray-400">
                <span class="bg-[#2A2A2A] px-3 py-1.5 rounded-lg" id="studentsQuantity">Total: 0 Students</span>
            </div>
        </div>
        
        <div class="grid gap-4 justify-center [grid-template-columns:repeat(auto-fit,minmax(0,420px))]
                    max-[480px]:grid-cols-1" id="studentsStackList">
            <div class="min-h-[400px] flex items-center justify-center w-full p-4">
                <div class="w-full max-w-4xl mx-auto">
                    <!-- Main Card -->
                    <div class="bg-gradient-to-br from-[#1E1E1E] to-[#2A2A2A] rounded-2xl p-8 shadow-2xl border border-gray-800 w-full">
                    <div class="flex flex-col md:flex-row items-center gap-8">
                        <!-- Icon Section -->
                        <div class="flex-shrink-0">
                        <div class="p-5 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                        </div>
                        </div>
                        
                        <!-- Content Section -->
                        <div class="flex-grow text-center md:text-left">
                        <h3 class="text-2xl md:text-3xl font-bold text-white mb-3">Ready to Mark Attendance</h3>
                        <p class="text-gray-300 text-lg mb-6 max-w-2xl">
                            Please select a class and date from the options above, then click "Get Attendance" to start marking student attendance.
                        </p>
                        
                        <!-- Call to Action -->
                        <div class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start">
                            <div class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-medium rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl cursor-default">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Select Class & Date to Begin
                            </div>
                            
                            <div class="inline-flex items-center px-5 py-3 bg-gray-800 hover:bg-gray-700 text-gray-300 font-medium rounded-xl transition-all duration-300 border border-gray-700 cursor-default">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                            View Help Guide
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Steps Indicator -->
                    <div class="mt-10 pt-6 border-t border-gray-800">
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-12">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center mr-3">
                            <span class="text-gray-300 font-medium">1</span>
                            </div>
                            <span class="text-gray-400">Select Class</span>
                        </div>
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center mr-3">
                            <span class="text-gray-300 font-medium">2</span>
                            </div>
                            <span class="text-gray-400">Choose Date</span>
                        </div>
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center mr-3">
                            <span class="text-gray-300 font-medium">3</span>
                            </div>
                            <span class="text-gray-400">Mark Attendance</span>
                        </div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- Additional Info Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                    <div class="bg-[#1E1E1E] rounded-xl p-5 border border-gray-800 hover:border-gray-700 transition-colors duration-300">
                        <div class="flex items-center mb-3">
                        <div class="p-2 bg-blue-900/30 rounded-lg mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h4 class="text-white font-medium">Quick Process</h4>
                        </div>
                        <p class="text-gray-400 text-sm">Mark attendance for your entire class in just a few clicks with our streamlined interface.</p>
                    </div>
                    
                    <div class="bg-[#1E1E1E] rounded-xl p-5 border border-gray-800 hover:border-gray-700 transition-colors duration-300">
                        <div class="flex items-center mb-3">
                        <div class="p-2 bg-green-900/30 rounded-lg mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <h4 class="text-white font-medium">Accurate Records</h4>
                        </div>
                        <p class="text-gray-400 text-sm">Maintain precise attendance records with automatic date tracking and student status indicators.</p>
                    </div>
                    
                    <div class="bg-[#1E1E1E] rounded-xl p-5 border border-gray-800 hover:border-gray-700 transition-colors duration-300">
                        <div class="flex items-center mb-3">
                        <div class="p-2 bg-purple-900/30 rounded-lg mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                        </div>
                        <h4 class="text-white font-medium">Export Data</h4>
                        </div>
                        <p class="text-gray-400 text-sm">Easily export attendance data to CSV or PDF for reporting and record-keeping purposes.</p>
                    </div>
                    </div>
                </div>
                </div>
        </div>
    </section>
</div>

<!-- Holiday Marking Modal -->
<div id="holidayModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="relative bg-[#1A1A1A] rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl border border-[#2A2A2A]">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold">Mark Holidays</h3>
            <button id="closeHolidayModal" class="text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form class="space-y-4" method="POST" action="/api/add-holiday">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Holiday Name *</label>
                <input type="text" class="w-full bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" 
                    placeholder="Enter holiday name" name="holiday_name" required>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Date Range *</label>
                <div class="flex gap-2">
                    <input type="date" class="flex-1 bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"
                        name="start_date" required>
                    <span class="self-center text-gray-400">to</span>
                    <input type="date" class="flex-1 bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"
                        name="end_date" required>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Apply To</label>
                <select class="w-full bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"
                    name="apply_to" required>
                    <option selected value="">Entire School</option>
                    {% if classes %}
                        {% for class in classes %}
                            <option value="{{ class.id }}">{{ class.CLASS }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="pt-4">
                <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-medium py-3.5 px-4 rounded-xl transition-all shadow-lg">
                    Mark as Holiday
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Send Message Modal -->
<div id="messageModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/70"></div>

    <div class="relative bg-[#1A1A1A] rounded-2xl w-full max-w-md shadow-2xl border border-[#2A2A2A]
                flex flex-col max-h-[90vh] overflow-hidden">

        <!-- Header (never scrolls) -->
        <div class="p-5 border-b border-[#2A2A2A] flex justify-between items-center">
            <h3 class="text-lg font-semibold" id="messageStudentName">Send Message</h3>
            <button id="closeMessageModal" class="text-gray-400 hover:text-white transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Message Area (only this part scrolls) -->
        <div class="p-5 flex-1 overflow-hidden">
            <label class="block text-sm font-medium text-gray-300 mb-2">Message</label>

            <textarea id="WatsappMessageTextArea"
                class="w-full h-full max-h-[50vh] bg-[#2A2A2A] border border-[#3A3A3A] text-white 
                       rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all 
                       resize-none overflow-y-auto"
                placeholder="Type your message here..."></textarea>
        </div>

        <!-- Footer (never scrolls) -->
        <div class="p-5 border-t border-[#2A2A2A]">
            <button id="sendWhatsAppBTN"
                class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 
                       text-white font-medium py-3.5 px-4 rounded-xl transition shadow-lg">
                <i class="fab fa-whatsapp mr-2"></i>Send via WhatsApp
            </button>
        </div>
    </div>
</div>


<!-- Attendance History Modal -->
<div id="attendanceHistoryModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="relative bg-[#1A1A1A] rounded-2xl p-6 w-full max-w-4xl mx-4 shadow-2xl max-h-[90vh] overflow-y-auto border border-[#2A2A2A]">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold" id="historyStudentName">Attendance History</h3>
            <button id="closeHistoryModal" class="text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Month Selector -->
        <div class="flex justify-between items-center mb-6">
            <button class="text-blue-500 hover:text-blue-400 transition-colors flex items-center">
                <i class="fas fa-chevron-left mr-1"></i> Previous Month
            </button>
            <h4 class="text-lg font-medium">November 2023</h4>
            <button class="text-blue-500 hover:text-blue-400 transition-colors flex items-center">
                Next Month <i class="fas fa-chevron-right ml-1"></i>
            </button>
        </div>
        
        <!-- Calendar View -->
        <div class="grid grid-cols-7 gap-2 mb-4">
            <div class="text-center text-gray-400 font-medium py-2">Sun</div>
            <div class="text-center text-gray-400 font-medium py-2">Mon</div>
            <div class="text-center text-gray-400 font-medium py-2">Tue</div>
            <div class="text-center text-gray-400 font-medium py-2">Wed</div>
            <div class="text-center text-gray-400 font-medium py-2">Thu</div>
            <div class="text-center text-gray-400 font-medium py-2">Fri</div>
            <div class="text-center text-gray-400 font-medium py-2">Sat</div>
            
            <!-- Empty days for November 2023 (starts on Wednesday) -->
            <div class="calendar-day"></div>
            <div class="calendar-day"></div>
            <div class="calendar-day"></div>
            
            <!-- Calendar Days -->
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">1</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">2</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">3</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">4</div>
                <div class="w-3 h-3 rounded-full bg-amber-500 mx-auto mt-1"></div>
            </div>
            
            <!-- Continue with more days... -->
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">5</div>
                <div class="w-3 h-3 rounded-full bg-red-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">6</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">7</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">8</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">9</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">10</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">11</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">12</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">13</div>
                <div class="w-3 h-3 rounded-full bg-purple-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">14</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">15</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">16</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">17</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">18</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">19</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">20</div>
                <div class="w-3 h-3 rounded-full bg-red-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">21</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">22</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">23</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">24</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">25</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">26</div>
                <div class="w-3 h-3 rounded-full bg-amber-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">27</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">28</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">29</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
            <div class="bg-[#2A2A2A] rounded-xl p-3 text-center">
                <div class="text-sm">30</div>
                <div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-1"></div>
            </div>
        </div>
        
        <!-- Legend -->
        <div class="flex flex-wrap justify-center gap-4 mt-6">
            <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                <span class="text-sm">Present</span>
            </div>
            <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-amber-500 mr-2"></div>
                <span class="text-sm">Half Day</span>
            </div>
            <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                <span class="text-sm">Absent</span>
            </div>
            <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-purple-500 mr-2"></div>
                <span class="text-sm">Holiday</span>
            </div>
        </div>
        
        <!-- Summary -->
        <div class="mt-8 pt-6 border-t border-[#3A3A3A]">
            <h4 class="text-lg font-medium mb-4">Attendance Summary</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-[#2A2A2A] rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-green-500">22</div>
                    <div class="text-sm text-gray-400">Present</div>
                </div>
                <div class="bg-[#2A2A2A] rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-amber-500">2</div>
                    <div class="text-sm text-gray-400">Half Day</div>
                </div>
                <div class="bg-[#2A2A2A] rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-red-500">2</div>
                    <div class="text-sm text-gray-400">Absent</div>
                </div>
                <div class="bg-[#2A2A2A] rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-purple-500">1</div>
                    <div class="text-sm text-gray-400">Holidays</div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{{ url_for('static', filename='watsappMessage.js') }}"></script>
<script>
    // Modal toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Holiday Modal
        const holidayBtn = document.getElementById('holidayBtn');
        const holidayModal = document.getElementById('holidayModal');
        const closeHolidayModal = document.getElementById('closeHolidayModal');
        const getAttendanceDataBTN = document.getElementById('getAttendanceDataBTN');
        const sendWhatsAppBTN = document.getElementById('sendWhatsAppBTN');

        getAttendanceDataBTN.addEventListener("click", async () => {
            const classID = document.getElementById("classSelector").value;
            const date = document.getElementById("dateSelector").value;

            if (!classID) return showAlert(400, "Select a class");
            if (!date) return showAlert(400, "Select a date");

            // Convert YYYY-MM-DD â†’ DD/MM/YYYY
            const attandanceData = await getAttendanceData(classID, date);

            if (!attandanceData) return;
            renderAttendanceData(attandanceData, date)
        });

        
        holidayBtn.addEventListener('click', function() {
            holidayModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });
        
        closeHolidayModal.addEventListener('click', function() {
            holidayModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        });
        
        // Message Modal
        const messageModal = document.getElementById('messageModal');
        const closeMessageModal = document.getElementById('closeMessageModal');
        
        closeMessageModal.addEventListener('click', function() {
            messageModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        });
        
        // Attendance History Modal
        const attendanceHistoryModal = document.getElementById('attendanceHistoryModal');
        const closeHistoryModal = document.getElementById('closeHistoryModal');
        
        closeHistoryModal.addEventListener('click', function() {
            attendanceHistoryModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        });

        sendWhatsAppBTN.addEventListener('click', function() {
            event.preventDefault(); // Prevent page reload
            const message = document.getElementById("WatsappMessageTextArea").value;
            const phone = sendWhatsAppBTN.getAttribute("data-phone")
            sendWhatsAppMessage(phone, message)
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === holidayModal) {
                holidayModal.classList.add('hidden');
            }
            if (event.target === messageModal) {
                messageModal.classList.add('hidden');
            }
            if (event.target === attendanceHistoryModal) {
                attendanceHistoryModal.classList.add('hidden');
            }
        });
        
    });



    async function getAttendanceData(classID, date) {
        if (!classID || !date) {
            showAlert(400, "classID and date are required");
            return false;
        }

        try {
            const query = new URLSearchParams({ classID, date });
            const response = await fetch(`/api/get_attendance_data?${query}`);
            const body = await response.json();
            

            if (!response.ok) {
                showAlert(response.status, body.message || "Request failed.");
                return false;
            }
            return body.attendance_data;    // Full JSON data

        } catch (error) {
            showAlert(500, "Network error!");
            return false;
        }
    }


    async function renderAttendanceData(attandanceData, date) {
        const container = document.getElementById('studentsStackList');
        const studentsQuantity = document.getElementById('studentsQuantity');

        container.innerHTML = ""; // clear old data

        if (attandanceData.length == 0){

        }

        attandanceData.forEach(data => {
            attandanceStatus = data.attendance_status

            let presentSelected  = attandanceStatus === "PRESENT" ? "selected" : "";
            let absentSelected   = attandanceStatus === "ABSENT" ? "selected" : "";
            let halfdaySelected  = attandanceStatus === "HALF_DAY" ? "selected" : "";

            let studentsCardHtml = `
            <div class="bg-[#1C1C1C] rounded-2xl p-5 border border-[#2A2A2A] shadow-xl hover:shadow-2xl hover:border-[#3A3A3A] transition-all duration-300">
                <!-- Header -->
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center gap-4">
                        <img src="https://lh3.googleusercontent.com/d/${data.IMAGE}=s200"
                            class="w-16 h-16 rounded-xl object-cover shadow-md"
                            loading="lazy">

                        <div>
                            <h3 class="text-lg font-semibold text-white leading-tight">${data.STUDENTS_NAME}</h3>
                            <p class="text-xs text-gray-400 leading-tight">C/O: ${data.FATHERS_NAME}</p>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button class="w-10 h-10 bg-green-600/90 hover:bg-green-600 text-white rounded-xl flex items-center justify-center shadow-lg transition"
                                onclick="openMessageModal('${data.STUDENTS_NAME}','${data.FATHERS_NAME}','${data.CLASS}','${data.PHONE}','${date}')">
                            <i class="fab fa-whatsapp"></i>
                        </button>

                        <button class="w-10 h-10 bg-blue-600/90 hover:bg-blue-600 text-white rounded-xl flex items-center justify-center shadow-lg transition hidden"
                                onclick="openAttendanceHistoryModal(${data.student_session_id})">
                            <i class="far fa-calendar-alt"></i>
                        </button>
                    </div>
                </div>

                <!-- Student Details -->
                <div class="flex gap-2 mb-5 text-sm">
                    <span class="bg-[#2A2A2A] px-3 py-1.5 rounded-lg">Class: ${data.CLASS}</span>
                    <span class="bg-[#2A2A2A] px-3 py-1.5 rounded-lg">Roll: ${data.ROLL}</span>
                </div>

                <!-- Attendance -->
                <div class="pt-4 border-t border-[#333]">
                    <div class="grid grid-cols-3 gap-3">

                        <button class="attendance-option present-option ${presentSelected} 
                            border border-green-600 text-green-500 bg-green-500/10 hover:bg-green-500/20
                            py-3 rounded-xl flex flex-col items-center gap-1 transition" data-student='${data.student_session_id}'
                            onclick="markAttendance('${data.student_session_id}', 'PRESENT', '${date}', this)">
                            <i class="fas fa-check-circle text-lg"></i>
                            <span class="text-xs font-semibold">Present</span>
                        </button>

                        <button class="attendance-option absent-option ${absentSelected}
                            border border-red-600 text-red-400 bg-red-500/10 hover:bg-red-500/20
                            py-3 rounded-xl flex flex-col items-center gap-1 transition" data-student='${data.student_session_id}'
                            onclick="markAttendance('${data.student_session_id}', 'ABSENT', '${date}', this)">
                            <i class="fas fa-times-circle text-lg"></i>
                            <span class="text-xs font-semibold">Absent</span>
                        </button>

                        <button class="attendance-option halfDay-option ${halfdaySelected}
                            border border-yellow-500 text-yellow-400 bg-yellow-400/10 hover:bg-yellow-400/20
                            py-3 rounded-xl flex flex-col items-center gap-1 transition" data-student='${data.student_session_id}'
                            onclick="markAttendance('${data.student_session_id}', 'HALF_DAY', '${date}', this)">
                            <i class="fas fa-clock text-lg"></i>
                            <span class="text-xs font-semibold">Half Day</span>
                        </button>

                    </div>
                </div>
            </div>
            `;
            container.insertAdjacentHTML("beforeend", studentsCardHtml);
        
        })
        studentsQuantity.textContent = `Total: ${attandanceData.length} Students`;

    }

    async function markAttendance(studentID, status, date, clickedBTN, remark=null) {
        // ---- 1. Input Validation (Fail Fast) ----
        if (!studentID) return showAlert(400, "Invalid student and its id!"); 
        if (!status) return showAlert(400, "Invalid attandance status selected!"); 
        if (!date) return showAlert(400, "Invalid selected date!");

        const isAlreadySelected = clickedBTN.classList.contains("selected");

        // Save current button content
        const originalHTML = clickedBTN.innerHTML;

        // Start loading state
        clickedBTN.disabled = true;
        clickedBTN.classList.add("loading-active");
        clickedBTN.innerHTML = `
            <div class="flex flex-col items-center gap-1">
                <div class="h-5 flex items-center justify-center">
                    <span class="loader-spin w-5 h-5 border-2 border-current border-t-transparent rounded-full"></span>
                </div>
                <span class="text-xs font-semibold opacity-80">Marking...</span>
            </div>
        `;

        try {
            if (isAlreadySelected) { status = null }
            const response = await fetch("/api/mark_attendance", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    student_session_id: studentID,
                    status: status,
                    date: date,
                    remark: remark
                })
            });
            const body = await response.json();
            
            if (!response.ok) {
                showAlert(response.status, body.message || `Server error: ${response.status}`);
                return;
            }

            if (clickedBTN.classList.contains("selected")) {
                clickedBTN.classList.remove("selected");
            } else {
                // unselect all others
                const group = document.querySelectorAll(`.attendance-option[data-student="${studentID}"]`);
                group.forEach(b => b.classList.remove("selected"));
                clickedBTN.classList.add("selected");
            }

        } catch (error) {
            showAlert(500, "Network error");
            console.error("Error:", error);
        } finally {
            // Restore button UI
            clickedBTN.disabled = false;
            clickedBTN.classList.remove("loading-active");
            clickedBTN.innerHTML = originalHTML;
        }
    }
    
    
    async function getAttendanceHistory(studentID, date, status) {}

    // =====================================================
    //  MODALS (simple)
    // =====================================================
    
    async function openMessageModal(studentName, fathersName, className, phone, date ) {
        document.getElementById("messageStudentName").textContent = `Send Message to ${studentName}`;
        let absentMessage = ""

        try {
            const query = new URLSearchParams({ studentName, fathersName, className, phone, date });
            const response = await fetch(`/api/get_absent_message?${query}`);
            const body = await response.json();
            
            if (!response.ok) {
                showAlert(response.status, body.message || "Request failed.");
                return;
            }
            absentMessage = body.absent_message;

        } catch (error) {
            showAlert(500, "Something went wrong, please tyy after reloding the page!");
            return false;
        }
        const textarea = document.getElementById("WatsappMessageTextArea");

        document.getElementById("messageModal").classList.remove("hidden");
        document.body.style.overflow = 'hidden';
        textarea.value = absentMessage;

        // Auto-expand
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
        sendWhatsAppBTN.setAttribute("data-phone", phone)
    }

    // Open attendance history modal with student name
    function openAttendanceHistoryModal(studentName) {
        document.getElementById('historyStudentName').textContent = `${studentName}'s Attendance History`;
        document.getElementById('attendanceHistoryModal').classList.remove('hidden');
    }

    function openAttendanceHistoryModal(name) {
        document.getElementById("historyStudentName").textContent = `${name}'s Attendance History`;
        document.getElementById("attendanceHistoryModal").classList.remove("hidden");
    }
</script>


{% endblock %}