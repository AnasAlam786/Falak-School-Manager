{% extends "base.html" %}
{% block title %}Add Student{% endblock %}
{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<style>
  /* Info Card */
  .info-card {
    transition: all 0.2s ease;
    background-color: #2A2A3D;
  }

  .info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
  }

  .gradient-border {
    position: relative;
    z-index: 0;
    border-radius: 12px;
    overflow: hidden;
    padding: 1px;
  }

  .gradient-border::before {
    content: '';
    position: absolute;
    z-index: -1;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #1E1E2F;
    border-radius: 12px;
  }

  .modal-entrance {
    animation: slideIn 0.3s ease-out forwards;
  }

  .section-header {
    position: relative;
  }


  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }

    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }


  .custom-bg-gray-darker {
    background-color: rgba(33, 37, 41, 0.7);
    /* #212529 with 70% opacity */
    color: #e9ecef;
  }

  .custom-border {
    border: 1px solid rgba(255, 255, 255, 0.15);
  }

  .red-error-border {
    border-color: #ff6b6b !important;
    box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2) !important;
  }

  
  select option {
    color: #1d212b; /* may work in some browsers */
  }

  .bottom-border {
    border-bottom: 1px solid #2A2E32;
  }
</style>

<!-- Hidden Success Alert -->
<div id="successAlert"
  class="hidden fixed z-[9999] top-4 right-4 flex items-center p-4 pr-6 rounded-lg bg-green-50 border border-green-200 text-green-700">
  <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
  </svg>
  <span class="font-medium" id="successMessage"></span>
</div>

<!-- Hidden Error Alert -->
<div id="errorAlert"
  class="hidden fixed z-[9999] top-4 right-4 flex items-center p-4 pr-6 rounded-lg bg-red-50 border border-red-200 text-red-700">
  <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
      d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
  </svg>
  <span class="font-medium" id="errorMessage"></span>
</div>

<!-- Page Header -->
<div class="flex flex-col md:flex-row justify-between items-center mb-6 ">
  <div>
    <h1 class="text-2xl md:text-3xl font-bold text-white">Student Admission</h1>
    <p class="text-gray-400 mt-1 md:mt-2 text-sm md:text-base">Add students by filling their information</p>
  </div>
  <div class="mt-4 md:mt-0">
    <button id="FormSubmit"
      class="bg-gradient-to-r from-blue-500 to-indigo-700 text-white px-6 py-3 rounded-xl font-medium flex items-center">
      <svg id="btn-spinner" class="hidden animate-spin w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
        viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" />
      </svg>
      <span id="btn-text"><i class="fa fa-paper-plane mr-2"></i>Submit</span>
    </button>
  </div>
</div>

<!-- Validation Summary -->
<div class="validation-summary hidden bg-danger/10 border border-danger/30 rounded-xl p-4 mb-5"
  id="validationSummary">
  <h4 class="text-danger mb-2 flex items-center gap-2"><i class="fas fa-exclamation-circle"></i> Please fix the
    following errors:</h4>
  <ul class="pl-5 text-[#ff9f9f]" id="errorList"></ul>
</div>


<form id="DataForm" class="p-0">
  <!-- Personal Information -->
  <div class="form-section custom-bg-gray-darker backdrop-blur-md rounded-xl custom-border p-3 mb-6 shadow-[0_4px_15px_rgba(0,0,0,1)]">

    <div class="section-header flex items-center mb-8 pb-4 bottom-border">
        <div class="section-icon w-12 h-12 bg-primary/15 rounded-xl flex items-center justify-center mr-4 text-primary">
            <i class="fas fa-user text-lg"></i>
        </div>
        <div>
            <h2 class="section-title text-xl font-semibold">Personal Information</h2>
            <p class="text-gray-500 text-sm mt-1">Basic details about the student</p>
        </div>
    </div>

    <div class="form-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% from "html-components/input.html" import render_input_field %}
      {% for InputDetails in PersonalInfo %}
        {{ render_input_field(InputDetails=InputDetails, section='PersonalInfo') }}
      {% endfor %}

    </div>
  </div>

  <!-- Academic Details -->
  <div
    class="form-section custom-bg-gray-darker backdrop-blur-md rounded-xl custom-border p-6 mb-6 shadow-[0_4px_15px_rgba(0,0,0,1)]">
    <div class="section-header flex items-center gap-4  pb-4 bottom-border">
      <!-- Icon container -->
      <div class="section-icon w-12 h-12 bg-primary/15 rounded-xl flex items-center justify-center text-primary shadow-sm">
        <i class="fas fa-graduation-cap text-lg"></i>
      </div>

      <!-- Title and subtitle -->
      <div>
        <h2 class="section-title text-xl font-semibold leading-tight">Academic Details</h2>
        <p class="text-gray-500 text-sm mt-1">Basic details about the student</p>
      </div>
    </div>


    <div class="form-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

      <!-- Student Status (always full width) -->
      <div class="col-span-1 md:col-span-2 lg:col-span-3">
        <!-- Your ultra-modern toggle -->
        <div class="flex flex-col items-center text-center p-5">
          <label class="form-label mb-5 font-semibold text-gray-light text-lg">
            Is the student new or old?
            <span class="text-red-600 font-bold">*</span>
          </label>

          <div class="flex items-center justify-center gap-6">
            <!-- New -->
            <label class="cursor-pointer">
              <input type="radio" name="student_status" value="new" class="peer hidden" checked>
              <div class="flex items-center gap-2 px-6 py-3 rounded-full border border-gray-500 text-gray-light font-medium 
                          transition-all duration-300 transform peer-checked:bg-gradient-to-r peer-checked:from-primary/80 peer-checked:to-primary 
                          peer-checked:text-white peer-checked:shadow-2xl peer-checked:scale-105 hover:scale-105 hover:border-primary hover:text-primary">
                <i class="fas fa-user-plus"></i>
                <span>New</span>
              </div>
            </label>

            <!-- Old -->
            <label class="cursor-pointer">
              <input type="radio" name="student_status" value="old" class="peer hidden">
              <div class="flex items-center gap-2 px-6 py-3 rounded-full border border-gray-500 text-gray-light font-medium 
                          transition-all duration-300 transform peer-checked:bg-gradient-to-r peer-checked:from-primary/80 peer-checked:to-primary 
                          peer-checked:text-white peer-checked:shadow-2xl peer-checked:scale-105 hover:scale-105 hover:border-primary hover:text-primary">
                <i class="fas fa-user-graduate"></i>
                <span>Old</span>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Academic Info Fields -->
      {% for InputDetails in AcademicInfo %}
      <div class="col-span-1"> <!-- each input takes 1 column on all devices -->
        {{ render_input_field(InputDetails=InputDetails, section='AcademicInfo') }}
      </div>
      {% endfor %}

    </div>

  </div>

  <!-- Guardian Information -->
  <div
    class="form-section custom-bg-gray-darker backdrop-blur-md rounded-xl custom-border p-3 mb-6 shadow-[0_4px_15px_rgba(0,0,0,1)]">
    <div class="section-header flex items-center gap-4 mb-8 pb-4 bottom-border">
      <!-- Icon container -->
      <div class="section-icon w-12 h-12 bg-primary/15 rounded-xl flex items-center justify-center text-primary shadow-sm">
        <i class="fas fa-user-friends text-lg"></i>
      </div>

      <!-- Title and optional subtitle -->
      <div>
        <h2 class="section-title text-xl font-semibold leading-tight">Guardian Information</h2>
        <p class="text-gray-500 text-sm mt-1">Parent or guardian contact details</p>
      </div>
    </div>


    <div class="form-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

      {% for InputDetails in GuardianInfo %}
        {{ render_input_field(InputDetails=InputDetails, section='GuardianInfo') }}
      {% endfor %}

    </div>
  </div>


  <!-- Contact Information -->
  <div
    class="form-section custom-bg-gray-darker backdrop-blur-md rounded-xl custom-border p-3 mb-6 shadow-[0_4px_15px_rgba(0,0,0,1)]">
    <div class="section-header flex items-center mb-6 pb-4 bottom-border">
      <div class="section-icon w-12 h-12 bg-primary/15 rounded-xl flex items-center justify-center mr-4 text-primary">
        <i class="fas fa-address-book"></i>
      </div>
      <h2 class="section-title text-[1.4rem] font-semibold">Contact Information</h2>
    </div>

    <div class="form-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

      {% for InputDetails in ContactInfo %}
        {{ render_input_field(InputDetails=InputDetails, section='ContactInfo') }}
      {% endfor %}

    </div>
  </div>


  <!-- Additional/Logistical Information -->
  <div
    class="form-section custom-bg-gray-darker backdrop-blur-md rounded-xl custom-border p-3 mb-6 shadow-[0_4px_15px_rgba(0,0,0,1)]">
    <div class="section-header flex items-center gap-4 mb-8 pb-4 bottom-border">
      <!-- Icon container -->
      <div class="section-icon w-12 h-12 bg-primary/15 rounded-xl flex items-center justify-center text-primary shadow-sm">
        <i class="fas fa-info-circle text-lg"></i>
      </div>

      <!-- Title and subtitle -->
      <div>
        <h2 class="section-title text-xl font-semibold leading-tight">Additional Information</h2>
        <p class="text-gray-500 text-sm mt-1">Other relevant details about the student</p>
      </div>
    </div>


    <div class="form-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

      {% for InputDetails in AdditionalInfo %}
        {{ render_input_field(InputDetails=InputDetails, section='AdditionalInfo') }}
      {% endfor %}

    </div>
  </div>

  {% from "html-components/image-uploader.html" import render_image_uploader %}
  {{ render_image_uploader(unique_suffix='new_student', label='Click to upload the image', image_url = '') }}

</form>



<div id="verificationModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 transition-opacity backdrop-blur-sm z-50 flex items-start justify-center p-3 overflow-y-auto">
  <div class="w-full max-w-3xl mt-10 modal-entrance">
    <!-- Main Card -->
    <div class="gradient-border">
      <div class="rounded-[11px] bg-darkPanel overflow-hidden">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 bg-gradient-to-r from-primary to-secondary">

          <div class="flex items-center">
            <div class="bg-white/20 p-3 rounded-xl mr-4">
              <i class="fas fa-school text-2xl text-white"></i>
            </div>

            <h2 class="text-2xl font-bold text-white text-center">{{ session['school_name'] }}</h2>
          </div>
          <button class="cancelModle text-2xl text-white hover:text-gray-200 transition-colors">
            <i class="fas fa-times-circle"></i>
          </button>
        </div>

        <!-- Body -->
        <div class="p-3">
          <!-- Student Profile -->
          <div class="flex flex-col items-center mb-8">
            <div class="relative mb-4">
              <div class="w-32 h-32 rounded-full bg-gradient-to-r from-primary to-secondary p-1">
                <img id="modal-image" src="https://cdn.pixabay.com/photo/2016/04/22/04/57/graduation-1345143_1280.png"
                  alt="Student Image" loading="lazy"
                  class="w-full h-full rounded-full object-cover border-4 border-darkPanel">
              </div>
              <div
                class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-primary text-white px-3 py-1 rounded-full text-xs font-semibold">
                VERIFICATION
              </div>
            </div>
            <h3 id="modal-studentName" class="text-2xl font-bold text-white mb-1"></h3>
            <p id="modal-admissionNo" class="text-gray-400"></p>
          </div>

          <!-- Info Cards Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Personal Info Card -->
            <div class="info-card bg-[#161625] rounded-xl p-3 shadow-[0_4px_15px_rgba(0,0,0,0.5)]">
              <h4 class="text-lg font-semibold text-white mb-4 flex items-center">
                <i class="fas fa-user-circle mr-2 text-primary"></i>
                Personal Information
              </h4>
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-gray-400">DOB</span>
                  <span id="modal-DOB" class="text-white font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Gender</span>
                  <span id="modal-gender" class="text-white font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Aadhar</span>
                  <span id="modal-aadhaar" class="text-white font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Caste Type</span>
                  <span id="modal-casteType" class="text-white font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Religion</span>
                  <span id="modal-religion" class="text-white font-medium"></span>
                </div>
              </div>
            </div>

            <!-- Academic Info Card -->
            <div class="info-card bg-[#161625] rounded-xl p-3 shadow-[0_4px_15px_rgba(0,0,0,0.5)]">
              <h4 class="text-lg font-semibold text-white mb-4 flex items-center">
                <i class="fas fa-graduation-cap mr-2 text-primary"></i>
                Academic Information
              </h4>
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-gray-400">Class</span>
                  <span id="modal-class" class="text-white font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Section</span>
                  <span id="modal-section" class="text-white font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Roll No</span>
                  <span id="modal-rollNo" class="text-white font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">SR Number</span>
                  <span id="modal-srNo" class="text-white font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Admission Date</span>
                  <span id="modal-admissionDate" class="text-white font-medium"></span>
                </div>
              </div>
            </div>

            <!-- Family Info Card -->
            <div class="info-card bg-[#161625] rounded-xl p-3 md:col-span-2 shadow-[0_4px_15px_rgba(0,0,0,0.5)]">
              <h4 class="text-lg font-semibold text-white mb-4 flex items-center">
                <i class="fas fa-users mr-2 text-primary"></i>
                Family Information
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <div class="space-y-2">
                    <div class="flex justify-between">
                      <span class="text-gray-400">Father Name</span>
                      <span id="modal-fatherName" class="text-white font-medium"></span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-400">Mother Name</span>
                      <span id="modal-motherName" class="text-white font-medium"></span>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="space-y-2">

                    <div class="flex justify-between">
                      <span class="text-gray-400">Contact</span>
                      <span id="modal-contact" class="text-white font-medium"></span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-400">PIN</span>
                      <span id="modal-pin" class="text-white font-medium"></span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Address Section with Special Handling -->
              <!-- <div class="mt-5 pt-4 border-t border-gray-800" id="siblings">
                                    <h5 class="text-gray-400 text-sm font-medium uppercase tracking-wider mb-2">Siblings</h5>
                                    <div class=" bg-gray-900/30 rounded-lg text-white font-medium ml-2">
                                        Arham Babu, 5th-78
                                    </div>
                                    <div class="address-box bg-gray-900/30 rounded-lg text-white font-medium ml-2">
                                        Arham Babu, 5th-78
                                    </div>
                                </div> -->


              <!-- Address Section with Special Handling -->
              <div class="mt-1 pt-4 border-t border-gray-800">
                <h5 class="text-gray-400 text-sm font-medium uppercase tracking-wider">Address:</h5>
                <div class="rounded-lg mt-1 ml-2 text-white font-medium" id="modal-address">

                </div>
              </div>
            </div>
          </div>

          <!-- Verification Notice -->
          <div class="bg-blue-900/20 rounded-xl p-4 mb-6">
            <div class="flex items-start">
              <div class="mr-3 mt-1 text-blue-400">
                <i class="fas fa-info-circle"></i>
              </div>
              <div class="text-sm text-blue-200">
                <p class="font-medium mb-1">Please verify all information carefully</p>
                <p>Once submitted, you cannot delete the student record!</p>
              </div>
            </div>
          </div>
          <!-- <div class="text-sm text-center text-gray-400">
                          <i class="far fa-clock mr-1"></i> Session: 2025-2026
                      </div> -->
        </div>

        <!-- Footer -->
        <div class="flex justify-between items-center border-t border-gray-800 bg-[#161625] px-6 py-4">

          <div class="flex space-x-3">
            <button type="button"
              class="cancelModle px-4 py-2.5 rounded-lg custom-border text-gray-300 hover:bg-gray-800 transition-colors font-medium">
              Cancel
            </button>
            <button id="finalSubmit"
              class="px-5 py-2.5 rounded-lg bg-gradient-to-r from-primary to-secondary text-white hover:opacity-90 transition-opacity font-medium flex items-center">
              <i class="fas fa-check-circle mr-2"></i> Confirm
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Choice Modal -->
<div id="admissionDoneModel"
  class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm">
  <div
    class="relative w-full max-w-sm scale-100 rounded-xl border border-neutral-700 bg-neutral-900 shadow-xl transition-transform duration-300 ease-out">

    <!-- Close Button -->
    <button id="closeAdmissionDoneModel" type="button"
      class="absolute -top-4 -right-4 rounded-full bg-white/10 p-2 text-white shadow-md hover:scale-105 hover:bg-white/20">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Modal Content -->
    <div class="p-6 pt-8 text-center">
      <!-- Header -->
      <div class="mb-5">
        <div class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-green-500/10">
          <svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-white">Admission Completed!</h3>
        <p class="mt-1 text-sm text-gray-300">Send a confirmation on WhatsApp or print the admission form below.</p>
      </div>

      <!-- Buttons -->
      <div class="space-y-3">
        <button id="sendMessageBTN" type="button"
          class="flex w-full items-center justify-center gap-2 rounded-lg bg-[#25D366] px-5 py-3 font-medium text-white transition-all hover:bg-[#1ebe5d] focus:outline-none focus:ring-2 focus:ring-emerald-400">
          <svg class="h-5 w-5" viewBox="0 0 32 32" fill="currentColor">
            <path
              d="M16 0C7.168 0 0 6.912 0 15.456c0 2.736.864 5.376 2.336 7.648L0 32l9.12-2.88c2.176.672 4.48.992 6.88.992 8.832 0 16-6.912 16-15.456S24.832 0 16 0zm0 28.448c-2.112 0-4.16-.352-6.064-1.024l-.432-.128-5.424 1.728 1.76-5.088-.288-.448c-1.36-2.112-2.064-4.512-2.064-7.008 0-6.752 5.6-12.256 12.496-12.256 6.912 0 12.496 5.504 12.496 12.256 0 6.72-5.584 12.256-12.48 12.256zm6.784-9.152c-.4-.208-2.368-1.168-2.736-1.296-.368-.128-.64-.192-.912.192s-1.04 1.296-1.28 1.552c-.24.256-.464.288-.864.096s-1.68-.624-3.2-1.984c-1.184-1.056-1.984-2.368-2.208-2.768s-.024-.608.176-.8c.176-.176.4-.464.608-.704.208-.256.288-.432.432-.72s.08-.544-.032-.768c-.112-.224-.912-2.176-1.248-2.976-.336-.8-.688-.688-.912-.704s-.512-.016-.784-.016-.72.096-1.104.544c-.384.448-1.44 1.408-1.44 3.424s1.472 3.984 1.68 4.256c.208.272 2.88 4.384 6.944 6.144.97.408 1.728.648 2.32.832.976.304 1.856.264 2.56.16.784-.112 2.368-.96 2.704-1.888.336-.928.336-1.728.24-1.888-.096-.16-.352-.256-.752-.448z" />
          </svg>
          Send Message
        </button>

        <button id="printFormBTN" type="button"
          class="flex w-full items-center justify-center gap-2 rounded-lg bg-blue-600 px-5 py-3 font-medium text-white transition hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M6 2h12a2 2 0 012 2v4H4V4a2 2 0 012-2zm12 12h2a2 2 0 002-2V9a2 2 0 00-2-2H4a2 2 0 00-2 2v3a2 2 0 002 2h2v4a2 2 0 002 2h8a2 2 0 002-2v-4z" />
          </svg>
          Print Admission Form
        </button>
      </div>
    </div>
  </div>
</div>



<script src="{{ url_for('static', filename='watsappMessage.js') }}"></script>
<script src="{{ url_for('static', filename='printAdmissionForm.js') }}"></script>
<script>

  const classSelect = document.getElementById('CLASS');
  const rollInput = document.getElementById('ROLL');
  // Extracted helper so we can call it both from the visible select and when
  // the CLASS is mirrored from Admission_Class while disabled.
  async function updateRollForClass(classId) {
    if (!classId) {
      if (rollInput) rollInput.value = '';
      return;
    }

    try {
      const resp = await fetch('/get_new_roll_api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ class_id: classId })
      });

      const result = await resp.json();

      if (!resp.ok) {
        showAlert(resp.status, result.message);
        console.error(`HTTP ${resp.status}`);
        return;
      }

      if (rollInput) rollInput.value = result.next_roll;

    } catch (err) {
      console.error('Error fetching next roll:', err);
    }
  }

  // wire the visible CLASS select change to update roll
  if (classSelect) {
    classSelect.addEventListener('change', async () => {
      await updateRollForClass(classSelect.value);
    });
  }


  const form = document.getElementById('DataForm');

    let avatarUploader;
    document.addEventListener('DOMContentLoaded', () => {
      // assign to the outer-scope variable (avoid shadowing with const)
      avatarUploader = new ImageUploader('new_student');
      avatarUploader.onChange((blob, status) => console.log('Avatar:', status, blob));
    });

  document.getElementById('FormSubmit').addEventListener('click', async function () {

    const formData = new FormData(form);
    const data = {};

      // ✅ Reset everything first
      document.getElementById('validationSummary').classList.add('hidden');
      document.getElementById('errorList').innerHTML = '';

      const allFields = form.querySelectorAll("input, select, textarea");
      allFields.forEach(input => {
        input.classList.remove('red-error-border');
        const errorElement = input.parentElement.querySelector(".error-message");
        if (errorElement) {
          errorElement.style.display = 'none';
          errorElement.textContent = "";
        }
      });

      try {
        const formData = await getFormData('DataForm');
        const { ok, pydanticData } = await pydanticVerification(formData);

        if (!ok) {
          console.error("Pydantic validation failed:", pydanticData.errors);
          return;
        }
        // If pydantic verification is successful, open the verification modal
        let imageURL = null;
        let croppedBlob = avatarUploader && typeof avatarUploader.getBlob === 'function' ? avatarUploader.getBlob() : null;
        if (typeof croppedBlob !== 'undefined' && croppedBlob !== null) {
          imageURL = URL.createObjectURL(croppedBlob);
        }
        const verifiedData = pydanticData.verifiedData
        openVerificationModal(verifiedData, imageURL);


      } catch (error) {
        showAlert(400, "Unexpected error occured!")
        console.error("Error occurred while submitting the form:", error);
      }
  });

  function getFormData(id) {
    const form = document.getElementById(id);
    formData = new FormData(form);
    return formData
  }



  async function pydanticVerification(formData) {
    let formDataObject = Object.fromEntries(formData.entries());

    try {
      const pydanticResponse = await fetch("/api/pydantic_verification", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formDataObject)
      });

      const pydanticData = await pydanticResponse.json();

      if (!pydanticResponse.ok) {

        pydanticData.errors.forEach(error => {
          const errorField = document.getElementById(error.field)
          const errorElement = errorField.parentElement.querySelector(".error-message");

          errorElement.style.display = 'block';
          errorElement.textContent = error.message;
          errorField.classList.add('red-error-border');


        });
        // scroll to the first error field
        errorField = document.getElementById(pydanticData.errors[0].field);
        errorField.focus();
        errorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return { ok: false, pydanticData: pydanticData };
      }
      // If validation is successful, return the verified data      
      return { ok: true, pydanticData: pydanticData };



    } catch (err) {
      showAlert(404, "An error occurred while verifying the form data.");
      console.error("Error occurred while submitting the form:", err);
    }
  }

  async function conflictVerification(pydenticVerifiedData) {
    try {

      const conflictResponse = await fetch("/api/conflict_verification", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(pydenticVerifiedData)
      });

      return conflictResponse;


    } catch (err) {
      showAlert(404, "An error occurred while verifying the form data.");
      throw new Error("Fetch error", err);
    }
  }


  async function openVerificationModal(verifiedData, imageURL) {
    // --- Student name ---

    document.getElementById('modal-studentName').innerText = verifiedData.find(item => item.field === "STUDENTS_NAME")?.value;
    document.getElementById('modal-admissionNo').innerText = `Admission No: ${verifiedData.find(item => item.field === "ADMISSION_NO")?.value}`;
    document.getElementById('modal-gender').innerText = verifiedData.find(item => item.field === "GENDER")?.value;
    document.getElementById('modal-aadhaar').innerText = verifiedData.find(item => item.field === "AADHAAR")?.value;
    document.getElementById('modal-casteType').innerText = verifiedData.find(item => item.field === "Caste_Type")?.value;
    document.getElementById('modal-religion').innerText = verifiedData.find(item => item.field === "RELIGION")?.value;
    document.getElementById('modal-section').innerText = verifiedData.find(item => item.field === "Section")?.value;
    document.getElementById('modal-rollNo').innerText = verifiedData.find(item => item.field === "ROLL")?.value;
    document.getElementById('modal-srNo').innerText = verifiedData.find(item => item.field === "SR")?.value;
    document.getElementById('modal-fatherName').innerText = verifiedData.find(item => item.field === "FATHERS_NAME")?.value;
    document.getElementById('modal-motherName').innerText = verifiedData.find(item => item.field === "MOTHERS_NAME")?.value;
    document.getElementById('modal-contact').innerText = verifiedData.find(item => item.field === "PHONE")?.value;
    document.getElementById('modal-pin').innerText = verifiedData.find(item => item.field === "PIN")?.value;
    document.getElementById('modal-address').innerText = verifiedData.find(item => item.field === "ADDRESS")?.value;
    document.getElementById('modal-DOB').innerText = verifiedData.find(item => item.field === "DOB")?.value;
    document.getElementById('modal-admissionDate').innerText = verifiedData.find(item => item.field === "ADMISSION_DATE")?.value;;

    // showing actual class name, instead of class_id
    const classSelectField = document.getElementById('CLASS'); // your select element
    const classId = verifiedData.find(item => item.field === "CLASS")?.value; // class_id from Pydantic
    const classOption = Array.from(classSelectField.options).find(opt => opt.value === classId);
    const className = classOption ? classOption.text : "Class ID: " + classId; // fallback to id if not found
    document.getElementById('modal-class').innerText = className;


    // --- Student image or placeholder ---
    const StudentImageInModal = document.getElementById('modal-image');
    StudentImageInModal.src = imageURL
      ? imageURL
      : 'https://cdn.pixabay.com/photo/2016/04/22/04/57/graduation-1345143_1280.png';

    // ---Show the modal ---
    document.getElementById('verificationModal').classList.remove('hidden');
    document.body.classList.add('overflow-hidden');

  }


  document.getElementById('finalSubmit').addEventListener('click', async function () {
    const submitButton = this;
    if (submitButton.disabled) return; // prevent double submission
    submitButton.disabled = true;
    submitButton.innerText = "Submitting...";

    try {

      const formData = await getFormData('DataForm');
      const { ok, pydanticData } = await pydanticVerification(formData);
      console.log("Submitting verified data:", pydanticData);


      if (!ok) {
        // close the modal
        document.getElementById('verificationModal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        console.error("Pydantic validation failed:", pydanticData.errors);
        throw new Error("Pydantic validation failed");
      }
      const verifiedData = pydanticData.verifiedData;
      
      const conflictResponse = await conflictVerification(verifiedData);
      const conflictData = await conflictResponse.json();

      if (!conflictResponse.ok) {
        document.getElementById('verificationModal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        document.getElementById('errorList').innerHTML = (`<li>${conflictData.message}</li>`);
        document.getElementById('validationSummary').classList.remove('hidden');

        showAlert(conflictResponse.status, conflictData.message || 'Conflict found');
        console.error("Conflict verification failed:", conflictData.message);
        throw new Error("Conflict verification failed");
      }
      let base64Image = null;
      let croppedBlob = avatarUploader && typeof avatarUploader.getBlob === 'function' ? avatarUploader.getBlob() : null;
      
      if (typeof croppedBlob !== 'undefined' && croppedBlob !== null) {
        base64Image = await convertBlobToBase64(croppedBlob);
      }

      const response = await fetch('/final_admission_api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: base64Image, verifiedData: verifiedData })
      });

      const data = await response.json();

      if (response.ok) {
        showAlert(response.status, data.message);
        document.getElementById('verificationModal').classList.add('hidden');
        document.getElementById('admissionDoneModel').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

        // document.getElementById('DataForm').reset();

        document.getElementById('sendMessageBTN').onclick = function () {
          sendMessage(data.student_id);
        };
        document.getElementById('printFormBTN').onclick = function () {
          printAdmissionForm(data.student_id);
        };
      } else {
        showAlert(response.status, data.message);
      }

    } catch (error) {
      console.error('Error:', error);
    }

    // Re-enable the button only after the response is handled
    submitButton.disabled = false;
    submitButton.innerText = "Final Submit";
  });



  async function sendMessage(studentID) {
    const response = await fetch(`/create_watsapp_message_api?student_id=${encodeURIComponent(studentID)}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    const data = await response.json();

    if (response.ok) {
      sendWhatsAppMessage(data.phone, data.watsapp_message);
    } else {
      showAlert(response.status, data.message);
    }
  }

  // close admission done modal
  document.getElementById('closeAdmissionDoneModel').addEventListener('click', function () {
    document.getElementById('admissionDoneModel').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  });




  function convertBlobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = function () {
        resolve(reader.result);  // base64 string
      };
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }


  function formatAadharNumber(input) {
    // Remove non-numeric chars
    let value = input.value.replace(/\D/g, '');

    // Insert hyphens after every 4 digits, up to 12 total
    if (value.length <= 12) {
      value = value.replace(/(\d{4})(\d{1,4})/, '$1-$2');
      value = value.replace(/(\d{4})(\d{1,4})/, '$1-$2');
      value = value.replace(/(\d{4})(\d{1,4})$/, '$1-$2');
    }
    input.value = value;
  }
  // wire it up once for all inputs with class "aadhar-input"
  document.addEventListener('DOMContentLoaded', () => {
    ['MOTHERS_AADHAR', 'AADHAAR', 'FATHERS_AADHAR'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', () => formatAadharNumber(el));
      }
    });
  });


  document.querySelectorAll('.cancelModle').forEach(function (element) {
    element.addEventListener('click', function () {
      document.getElementById('verificationModal').classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    });
  });

</script>

<script>
  const studentRadios = document.querySelectorAll('input[name="student_status"]');
  const admission_session_id = document.getElementById('admission_session_id');
  const admissionClassSelect = document.getElementById('Admission_Class');
  const currentClassSelect = document.getElementById('CLASS');

  // Generic helpers to create/remove/sync a hidden mirror for a select element.
  function getMirrorIdFor(selectElem) {
    return selectElem.id + '_hidden_mirror';
  }

  function ensureHiddenMirror(selectElem) {
    if (!selectElem) return null;
    const form = selectElem.form || document.getElementById('DataForm');
    if (!form) return null;
    const MIRROR_ID = getMirrorIdFor(selectElem);
    let mirror = document.getElementById(MIRROR_ID);
    if (!mirror) {
      mirror = document.createElement('input');
      mirror.type = 'hidden';
      mirror.id = MIRROR_ID;
      mirror.name = selectElem.name || selectElem.id;
      form.appendChild(mirror);
    }
    mirror.value = selectElem.value;
    return mirror;
  }

  function removeHiddenMirror(selectElem) {
    if (!selectElem) return;
    const MIRROR_ID = getMirrorIdFor(selectElem);
    const mirror = document.getElementById(MIRROR_ID);
    if (mirror) mirror.remove();
  }

  function syncMirror(selectElem) {
    if (!selectElem) return;
    if (selectElem.disabled) {
      ensureHiddenMirror(selectElem);
    } else {
      removeHiddenMirror(selectElem);
    }
  }

  // Handle student status radio changes (new vs old)
  studentRadios.forEach(radio => {
    radio.addEventListener('change', () => {
      // admission_session handling
      if (admission_session_id) {
        if (radio.value === 'old') {
          admission_session_id.disabled = false;
        } else {
          const firstOption = [...admission_session_id.options].find(opt => !opt.hidden);
          if (firstOption) admission_session_id.value = firstOption.value;
          admission_session_id.disabled = true;
        }
        syncMirror(admission_session_id);
      }

      // CLASS and Admission_Class handling
      if (admissionClassSelect && currentClassSelect) {
        if (radio.value === 'old') {
          // both should be enabled and independent
          admissionClassSelect.disabled = false;
          currentClassSelect.disabled = false;
        } else {
          // New: Admission_Class is editable; CLASS reflects it and is disabled
          admissionClassSelect.disabled = false;
          // set current class value to admission class selection (or first option fallback)
          const admissionVal = admissionClassSelect.value || (admissionClassSelect.options[0] && admissionClassSelect.options[0].value) || '';
          currentClassSelect.value = admissionVal;
          currentClassSelect.disabled = true;
        }

        // Sync mirrors accordingly
        syncMirror(currentClassSelect);
      }
    });
  });

  // When Admission_Class changes while CLASS is disabled (New case), mirror the value
  if (admissionClassSelect) {
    admissionClassSelect.addEventListener('change', () => {
      if (currentClassSelect && currentClassSelect.disabled) {
        currentClassSelect.value = admissionClassSelect.value;
        syncMirror(currentClassSelect);
        // Also update dependent fields (roll) since CLASS change won't fire while disabled
        if (typeof updateRollForClass === 'function') {
          updateRollForClass(admissionClassSelect.value);
        }
      }
    });
  }

  // Also keep admission_session mirror updated on value change
  if (admission_session_id) {
    admission_session_id.addEventListener('change', () => syncMirror(admission_session_id));
  }

  // Initialize on page load: set initial enabled/disabled states and mirrors
  document.addEventListener('DOMContentLoaded', () => {
    // Determine currently selected student_status
    const checked = document.querySelector('input[name="student_status"]:checked');
    const status = checked ? checked.value : null;

    // admission_session
    if (admission_session_id) {
      if (status === 'old') {
        admission_session_id.disabled = false;
      } else {
        const firstOption = [...admission_session_id.options].find(opt => !opt.hidden);
        if (firstOption) admission_session_id.value = firstOption.value;
        admission_session_id.disabled = true;
      }
      syncMirror(admission_session_id);
    }

    // CLASS and Admission_Class initial setup
    if (admissionClassSelect && currentClassSelect) {
      if (status === 'old') {
        admissionClassSelect.disabled = false;
        currentClassSelect.disabled = false;
        // ensure no mirror if enabled
        syncMirror(currentClassSelect);
      } else {
        admissionClassSelect.disabled = false; // admission class must be selectable
        const admissionVal = admissionClassSelect.value || (admissionClassSelect.options[0] && admissionClassSelect.options[0].value) || '';
        currentClassSelect.value = admissionVal;
        currentClassSelect.disabled = true;
        syncMirror(currentClassSelect);
      }
    }
  });
</script>

{% endblock %}