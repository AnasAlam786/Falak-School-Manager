{% extends "base.html" %}
{% block title %}Admit Cards Preview{% endblock %}
{% block content %}

<div class="mx-auto">
  <!-- Header Section -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-white">Admit Card Generator</h1>
    <p class="mt-2 text-gray-400">Generate and preview admit cards for your students</p>
  </div>

  <!-- Controls Section -->
  <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-2xl p-4 sm:p-6 mb-6 border border-gray-700">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <!-- Class Selection -->
      <div>
        <label for="classSelect" class="block text-sm font-medium text-gray-300 mb-2">Select Class</label>
        <select id="classSelect" class="w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-3 px-4 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200 backdrop-blur-sm">
          <option value="" selected hidden disabled>Select Class</option>
          {% if classes %}
            {% for class in classes %}
              <option value="{{ class.id }}">{{ class.CLASS }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>

      <!-- Exam Input -->
      <div>
        <label for="examInput" class="block text-sm font-medium text-gray-300 mb-2">Exam</label>
        <input id="examInput" class="w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-3 px-4 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200 backdrop-blur-sm" placeholder="e.g. Half Yearly" />
      </div>

      <!-- Year Input -->
      <div>
        <label for="yearInput" class="block text-sm font-medium text-gray-300 mb-2">Year</label>
        <input id="yearInput" class="w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-3 px-4 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200 backdrop-blur-sm" placeholder="e.g. 2025" />
      </div>
    </div>

    <!-- Output Type Selection -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-300 mb-3">Select Output Type</label>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div class="flex items-center bg-gray-700/30 rounded-lg p-3 border border-gray-600/50 hover:border-indigo-500/30 transition-colors duration-200">
          <input id="examSchemaOnly" type="radio" name="outputType" value="schemaOnly" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-600 bg-gray-700">
          <label for="examSchemaOnly" class="ml-3 block text-sm text-gray-300">Exam Schema Only</label>
        </div>
        <div class="flex items-center bg-gray-700/30 rounded-lg p-3 border border-gray-600/50 hover:border-indigo-500/30 transition-colors duration-200">
          <input id="admitCardOnly" type="radio" name="outputType" value="admitOnly" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-600 bg-gray-700">
          <label for="admitCardOnly" class="ml-3 block text-sm text-gray-300">Admit Card Only</label>
        </div>
        <div class="flex items-center bg-gray-700/30 rounded-lg p-3 border border-gray-600/50 hover:border-indigo-500/30 transition-colors duration-200">
          <input id="both" type="radio" name="outputType" value="both" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-600 bg-gray-700" checked>
          <label for="both" class="ml-3 block text-sm text-gray-300">Both</label>
        </div>
      </div>
    </div>

    <!-- Generate Button -->
    <div class="mb-4">
      <button id="previewBtn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-900 shadow-lg hover:shadow-indigo-500/20">
        Generate Preview
      </button>
    </div>

    <!-- Exam Schema Inputs (Conditional) -->
    <div id="examSchemaContainer" class="border-t border-gray-700 pt-6 mt-6 hidden">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
        <h3 class="text-lg font-medium text-gray-300">Exam Schedule</h3>
        <button type="button" id="addExamRow" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 focus:ring-offset-gray-900 shadow-md transition-all duration-200 w-full sm:w-auto">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Add Exam
        </button>
      </div>
      
      <!-- Desktop Layout -->
      <div class="hidden lg:block">
        <div class="bg-gray-700/50 rounded-t-lg border border-gray-600/50 p-4 grid grid-cols-12 gap-4 mb-2">
          <div class="col-span-1 text-xs font-medium text-gray-400 uppercase tracking-wider text-center">Order</div>
          <div class="col-span-3 text-xs font-medium text-gray-400 uppercase tracking-wider">Date</div>
          <div class="col-span-3 text-xs font-medium text-gray-400 uppercase tracking-wider">Day</div>
          <div class="col-span-3 text-xs font-medium text-gray-400 uppercase tracking-wider">Exam Name</div>
          <div class="col-span-2 text-xs font-medium text-gray-400 uppercase tracking-wider text-center">Actions</div>
        </div>
        
        <div id="examSchemaInputs" class="space-y-3">
          <div class="exam-row bg-gray-700/30 rounded-lg border border-gray-600/30 p-4 grid grid-cols-12 gap-4 items-center transition-all duration-200 hover:border-gray-500/50 hover:bg-gray-700/40">
            <div class="col-span-1 flex justify-center">
              <span class="text-sm font-medium text-gray-300 order-display">1</span>
            </div>
            <div class="col-span-3">
              <input type="text" class="exam-date w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="DD/MM/YYYY" />
            </div>
            <div class="col-span-3">
              <input type="text" class="exam-day w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="e.g. Monday" />
            </div>
            <div class="col-span-3">
              <input type="text" class="exam-name w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="e.g. English" />
            </div>
            <div class="col-span-2 flex justify-center space-x-2">
              <button type="button" class="move-up inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-blue-600/80 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                </svg>
              </button>
              <button type="button" class="move-down inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-blue-600/80 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <button type="button" class="remove-exam-row inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-red-600/80 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile/Tablet Layout -->
      <div class="lg:hidden">
        <div id="examSchemaInputsMobile" class="space-y-4">
          <div class="exam-row-mobile bg-gray-700/30 rounded-xl border border-gray-600/30 p-4 transition-all duration-200 hover:border-gray-500/50 hover:bg-gray-700/40">
            <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-600/30">
              <span class="text-sm font-medium text-gray-300 order-display">Exam 1</span>
              <div class="flex space-x-2">
                <button type="button" class="move-up inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-blue-600/80 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                  </svg>
                </button>
                <button type="button" class="move-down inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-blue-600/80 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
                <button type="button" class="remove-exam-row inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-red-600/80 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div class="space-y-3">
              <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Date</label>
                <input type="text" class="exam-date w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="DD/MM/YYYY" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Day</label>
                <input type="text" class="exam-day w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="e.g. Monday" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Exam Name</label>
                <input type="text" class="exam-name w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="e.g. English" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-2xl p-4 mb-6 border border-gray-700">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
      <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
        <button id="printBtn" class="inline-flex items-center justify-center px-5 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 focus:ring-offset-gray-900 shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 w-full sm:w-auto">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
          </svg>
          Print All Pages
        </button>
        <button id="downloadBtn" class="inline-flex items-center justify-center px-5 py-2.5 border border-gray-600 text-sm font-medium rounded-lg text-gray-300 bg-gray-700/50 hover:bg-gray-600/50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-900 shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 w-full sm:w-auto">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-8m-6-4l4 4m0 0l4-4m-4 4V2"></path>
          </svg>
          Open in New Window
        </button>
      </div>
      <div id="previewStatus" class="text-sm text-gray-400 text-center sm:text-right w-full sm:w-auto mt-2 sm:mt-0">Select a class and click "Generate Preview"</div>
    </div>
  </div>

  <!-- Preview Area -->
  <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-2xl p-4 sm:p-6 border border-gray-700">
    <h2 class="text-lg font-medium text-white mb-4">Preview</h2>
    <div id="AdmitPreview" class="border-2 border-dashed border-gray-600 rounded-xl p-4 min-h-[300px] bg-gray-900/50"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const previewBtn = document.getElementById('previewBtn');
    const printBtn = document.getElementById('printBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const previewStatus = document.getElementById('previewStatus');
    const previewContainer = document.getElementById('AdmitPreview');
    const examSchemaContainer = document.getElementById('examSchemaContainer');
    const examSchemaInputs = document.getElementById('examSchemaInputs');
    const examSchemaInputsMobile = document.getElementById('examSchemaInputsMobile');
    const addExamRowBtn = document.getElementById('addExamRow');
    const outputTypeRadios = document.querySelectorAll('input[name="outputType"]');
    
    // Initialize the form
    initializeForm();
    
    function initializeForm() {
      // Load saved data from localStorage
      loadSavedData();
      
      // Show/hide exam schema inputs based on output type selection
      outputTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'admitOnly') {
            examSchemaContainer.classList.add('hidden');
          } else {
            examSchemaContainer.classList.remove('hidden');
          }
          saveFormData();
        });
      });
      
      // Add new exam row
      addExamRowBtn.addEventListener('click', function() {
        addExamRow();
        saveFormData();
        updateOrderNumbers();
      });
      
      // Event delegation for remove buttons and move buttons (Desktop)
      examSchemaInputs.addEventListener('click', function(e) {
        if (e.target.closest('.remove-exam-row')) {
          // Don't remove if it's the last row
          if (examSchemaInputs.querySelectorAll('.exam-row').length > 1) {
            e.target.closest('.exam-row').remove();
            updateMobileLayout();
            saveFormData();
            updateOrderNumbers();
          }
        }
        
        if (e.target.closest('.move-up')) {
          const row = e.target.closest('.exam-row');
          moveRowUp(row);
        }
        
        if (e.target.closest('.move-down')) {
          const row = e.target.closest('.exam-row');
          moveRowDown(row);
        }
      });
      
      // Event delegation for remove buttons and move buttons (Mobile)
      examSchemaInputsMobile.addEventListener('click', function(e) {
        if (e.target.closest('.remove-exam-row')) {
          // Don't remove if it's the last row
          if (examSchemaInputsMobile.querySelectorAll('.exam-row-mobile').length > 1) {
            e.target.closest('.exam-row-mobile').remove();
            updateDesktopLayout();
            saveFormData();
            updateOrderNumbers();
          }
        }
        
        if (e.target.closest('.move-up')) {
          const row = e.target.closest('.exam-row-mobile');
          moveRowUpMobile(row);
        }
        
        if (e.target.closest('.move-down')) {
          const row = e.target.closest('.exam-row-mobile');
          moveRowDownMobile(row);
        }
      });
      
      // Add input listeners to all existing inputs
      setupInputListeners();
    }
    
    // Function to move a row up (Desktop)
    function moveRowUp(row) {
      const previousRow = row.previousElementSibling;
      if (previousRow) {
        row.parentNode.insertBefore(row, previousRow);
        updateMobileLayout();
        updateOrderNumbers();
        saveFormData();
      }
    }
    
    // Function to move a row down (Desktop)
    function moveRowDown(row) {
      const nextRow = row.nextElementSibling;
      if (nextRow) {
        row.parentNode.insertBefore(nextRow, row);
        updateMobileLayout();
        updateOrderNumbers();
        saveFormData();
      }
    }
    
    // Function to move a row up (Mobile)
    function moveRowUpMobile(row) {
      const previousRow = row.previousElementSibling;
      if (previousRow) {
        row.parentNode.insertBefore(row, previousRow);
        updateDesktopLayout();
        updateOrderNumbers();
        saveFormData();
      }
    }
    
    // Function to move a row down (Mobile)
    function moveRowDownMobile(row) {
      const nextRow = row.nextElementSibling;
      if (nextRow) {
        row.parentNode.insertBefore(nextRow, row);
        updateDesktopLayout();
        updateOrderNumbers();
        saveFormData();
      }
    }
    
    // Function to update the order numbers displayed
    function updateOrderNumbers() {
      // Update desktop view
      const rows = examSchemaInputs.querySelectorAll('.exam-row');
      rows.forEach((row, index) => {
        const orderDisplay = row.querySelector('.order-display');
        if (orderDisplay) {
          orderDisplay.textContent = index + 1;
        }
      });
      
      // Update mobile view
      const mobileRows = examSchemaInputsMobile.querySelectorAll('.exam-row-mobile');
      mobileRows.forEach((row, index) => {
        const orderDisplay = row.querySelector('.order-display');
        if (orderDisplay) {
          orderDisplay.textContent = `Exam ${index + 1}`;
        }
      });
    }
    
    // Function to add a new exam row
    function addExamRow() {
      addDesktopRow();
      addMobileRow();
      updateOrderNumbers();
    }
    
    // Function to add a desktop row
    function addDesktopRow() {
      const newRow = document.createElement('div');
      newRow.className = 'exam-row bg-gray-700/30 rounded-lg border border-gray-600/30 p-4 grid grid-cols-12 gap-4 items-center transition-all duration-200 hover:border-gray-500/50 hover:bg-gray-700/40';
      newRow.innerHTML = `
        <div class="col-span-1 flex justify-center">
          <span class="text-sm font-medium text-gray-300 order-display">${examSchemaInputs.querySelectorAll('.exam-row').length + 1}</span>
        </div>
        <div class="col-span-3">
          <input type="text" class="exam-date w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="DD/MM/YYYY" />
        </div>
        <div class="col-span-3">
          <input type="text" class="exam-day w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="e.g. Monday" />
        </div>
        <div class="col-span-3">
          <input type="text" class="exam-name w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="e.g. English" />
        </div>
        <div class="col-span-2 flex justify-center space-x-2">
          <button type="button" class="move-up inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-blue-600/80 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
            </svg>
          </button>
          <button type="button" class="move-down inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-blue-600/80 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <button type="button" class="remove-exam-row inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-red-600/80 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      `;
      
      examSchemaInputs.appendChild(newRow);
      setupInputListenersForRow(newRow);
    }
    
    // Function to add a mobile row
    function addMobileRow() {
      const newRow = document.createElement('div');
      newRow.className = 'exam-row-mobile bg-gray-700/30 rounded-xl border border-gray-600/30 p-4 transition-all duration-200 hover:border-gray-500/50 hover:bg-gray-700/40';
      newRow.innerHTML = `
        <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-600/30">
          <span class="text-sm font-medium text-gray-300 order-display">Exam ${examSchemaInputsMobile.querySelectorAll('.exam-row-mobile').length + 1}</span>
          <div class="flex space-x-2">
            <button type="button" class="move-up inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-blue-600/80 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
              </svg>
            </button>
            <button type="button" class="move-down inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-blue-600/80 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <button type="button" class="remove-exam-row inline-flex items-center p-2 border border-transparent rounded-lg text-white bg-red-600/80 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 focus:ring-offset-gray-900 transition-all duration-200 shadow-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="space-y-3">
          <div>
            <label class="block text-xs font-medium text-gray-400 mb-1">Date</label>
            <input type="text" class="exam-date w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="DD/MM/YYYY" />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-400 mb-1">Day</label>
            <input type="text" class="exam-day w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="e.g. Monday" />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-400 mb-1">Exam Name</label>
            <input type="text" class="exam-name w-full rounded-lg border border-gray-600 bg-gray-700/50 text-white py-2.5 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all duration-200" placeholder="e.g. English" />
          </div>
        </div>
      `;
      
      examSchemaInputsMobile.appendChild(newRow);
      setupInputListenersForRowMobile(newRow);
    }
    
    // Update mobile layout when desktop changes
    function updateMobileLayout() {
      examSchemaInputsMobile.innerHTML = '';
      const desktopRows = examSchemaInputs.querySelectorAll('.exam-row');
      
      desktopRows.forEach((desktopRow, index) => {
        const date = desktopRow.querySelector('.exam-date').value;
        const day = desktopRow.querySelector('.exam-day').value;
        const examName = desktopRow.querySelector('.exam-name').value;
        
        addMobileRow();
        const newMobileRow = examSchemaInputsMobile.querySelector('.exam-row-mobile:last-child');
        newMobileRow.querySelector('.exam-date').value = date;
        newMobileRow.querySelector('.exam-day').value = day;
        newMobileRow.querySelector('.exam-name').value = examName;
      });
    }
    
    // Update desktop layout when mobile changes
    function updateDesktopLayout() {
      examSchemaInputs.innerHTML = '';
      const mobileRows = examSchemaInputsMobile.querySelectorAll('.exam-row-mobile');
      
      mobileRows.forEach((mobileRow, index) => {
        const date = mobileRow.querySelector('.exam-date').value;
        const day = mobileRow.querySelector('.exam-day').value;
        const examName = mobileRow.querySelector('.exam-name').value;
        
        addDesktopRow();
        const newDesktopRow = examSchemaInputs.querySelector('.exam-row:last-child');
        newDesktopRow.querySelector('.exam-date').value = date;
        newDesktopRow.querySelector('.exam-day').value = day;
        newDesktopRow.querySelector('.exam-name').value = examName;
      });
    }
    
    // Set up input listeners for all form elements
    function setupInputListeners() {
      const formInputs = ['classSelect', 'examInput', 'yearInput'];
      
      formInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.addEventListener('input', saveFormData);
          input.addEventListener('change', saveFormData);
        }
      });
      
      // Save output type radio selections
      outputTypeRadios.forEach(radio => {
        radio.addEventListener('change', saveFormData);
      });
      
      // Add input listeners to all existing exam inputs (Desktop)
      document.querySelectorAll('.exam-date, .exam-day, .exam-name').forEach(input => {
        input.addEventListener('input', function() {
          syncInputs(this);
          saveFormData();
        });
      });
    }
    
    // Set up input listeners for a specific row (Desktop)
    function setupInputListenersForRow(row) {
      const inputs = row.querySelectorAll('.exam-date, .exam-day, .exam-name');
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          syncInputs(this);
          saveFormData();
        });
      });
    }
    
    // Set up input listeners for a specific row (Mobile)
    function setupInputListenersForRowMobile(row) {
      const inputs = row.querySelectorAll('.exam-date, .exam-day, .exam-name');
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          syncInputs(this);
          saveFormData();
        });
      });
    }
    
    // Sync inputs between desktop and mobile views
    function syncInputs(changedInput) {
      const value = changedInput.value;
      const className = changedInput.className.includes('exam-date') ? 'exam-date' : 
                       changedInput.className.includes('exam-day') ? 'exam-day' : 'exam-name';
      
      // Find the corresponding input in the other view
      const allInputs = document.querySelectorAll(`.${className}`);
      allInputs.forEach(input => {
        if (input !== changedInput) {
          // Find if they are in the same position
          const changedRow = changedInput.closest('.exam-row, .exam-row-mobile');
          const currentRow = input.closest('.exam-row, .exam-row-mobile');
          
          if (changedRow && currentRow) {
            const changedIndex = Array.from(changedRow.parentNode.children).indexOf(changedRow);
            const currentIndex = Array.from(currentRow.parentNode.children).indexOf(currentRow);
            
            if (changedIndex === currentIndex) {
              input.value = value;
            }
          }
        }
      });
    }
    
    // Load saved data from localStorage
    function loadSavedData() {
      const savedData = localStorage.getItem('admitCardFormData');
      if (savedData) {
        const data = JSON.parse(savedData);
        
        // Set form values
        const formInputs = ['classSelect', 'examInput', 'yearInput'];
        formInputs.forEach(inputId => {
          const input = document.getElementById(inputId);
          if (input && data[inputId]) {
            input.value = data[inputId];
          }
        });
        
        // Set output type
        if (data.outputType) {
          const radio = document.querySelector(`input[name="outputType"][value="${data.outputType}"]`);
          if (radio) {
            radio.checked = true;
            // Trigger change event to show/hide exam schema inputs
            radio.dispatchEvent(new Event('change'));
          }
        }
        
        // Load exam schema data
        if (data.examSchema && data.examSchema.length > 0) {
          // Clear existing rows
          examSchemaInputs.innerHTML = '';
          examSchemaInputsMobile.innerHTML = '';
          
          // Add rows for each exam schema entry
          data.examSchema.forEach((exam, index) => {
            addExamRow();
            const newDesktopRow = examSchemaInputs.querySelector('.exam-row:last-child');
            const newMobileRow = examSchemaInputsMobile.querySelector('.exam-row-mobile:last-child');
            
            if (newDesktopRow) {
              newDesktopRow.querySelector('.exam-date').value = exam.date || '';
              newDesktopRow.querySelector('.exam-day').value = exam.day || '';
              newDesktopRow.querySelector('.exam-name').value = exam.examName || '';
            }
            
            if (newMobileRow) {
              newMobileRow.querySelector('.exam-date').value = exam.date || '';
              newMobileRow.querySelector('.exam-day').value = exam.day || '';
              newMobileRow.querySelector('.exam-name').value = exam.examName || '';
            }
          });
          
          // If no exam schema data, ensure we have at least one row
          if (data.examSchema.length === 0) {
            addExamRow();
          }
        }
      } else {
        // Ensure we have at least one exam row
        if (examSchemaInputs.querySelectorAll('.exam-row').length === 0) {
          addExamRow();
        }
      }
      
      updateOrderNumbers();
    }
    
    // Save form data to localStorage
    function saveFormData() {
      const formData = {};
      
      // Save form inputs
      const formInputs = ['classSelect', 'examInput', 'yearInput'];
      formInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          formData[inputId] = input.value;
        }
      });
      
      // Save output type
      const selectedOutputType = document.querySelector('input[name="outputType"]:checked');
      if (selectedOutputType) {
        formData.outputType = selectedOutputType.value;
      }
      
      // Save exam schema data in current order (using desktop view as source)
      const examRows = examSchemaInputs.querySelectorAll('.exam-row');
      formData.examSchema = [];
      
      examRows.forEach(row => {
        const date = row.querySelector('.exam-date').value;
        const day = row.querySelector('.exam-day').value;
        const examName = row.querySelector('.exam-name').value;
        
        // Only add if at least one field has data
        if (date || day || examName) {
          formData.examSchema.push({
            date: date,
            day: day,
            examName: examName
          });
        }
      });
      
      localStorage.setItem('admitCardFormData', JSON.stringify(formData));
    }
    
    previewBtn.addEventListener('click', async () => {
      const CLASS = document.getElementById('classSelect').value;
      const exam = document.getElementById('examInput').value;
      const year = document.getElementById('yearInput').value;
      const outputType = document.querySelector('input[name="outputType"]:checked').value;
      
      // Collect exam schema data in current order (using desktop view)
      const examSchema = [];
      const examRows = examSchemaInputs.querySelectorAll('.exam-row');
      examRows.forEach(row => {
        const date = row.querySelector('.exam-date').value;
        const day = row.querySelector('.exam-day').value;
        const examName = row.querySelector('.exam-name').value;
        
        if (date || day || examName) {
          examSchema.push({
            date: date,
            day: day,
            examName: examName
          });
        }
      });

      if (!CLASS) {
        previewStatus.textContent = 'Please select a class.';
        previewStatus.classList.remove('text-green-500');
        previewStatus.classList.add('text-red-500');
        return;
      }

      previewStatus.textContent = 'Loading preview...';
      previewStatus.classList.remove('text-red-500', 'text-green-500');
      previewStatus.classList.add('text-blue-400');
      previewBtn.disabled = true;
      previewBtn.classList.add('opacity-50', 'cursor-not-allowed');

      try {
        const resp = await fetch('/admit_cards_api', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            class: CLASS, 
            exam: exam, 
            year: year, 
            outputType: outputType,
            examSchema: examSchema
          })
        });

        const body = await resp.json();

        if (!resp.ok) {
          previewStatus.textContent = body.message || 'Server error while generating preview.';
          previewStatus.classList.remove('text-blue-400');
          previewStatus.classList.add('text-red-500');
          previewContainer.innerHTML = '';
          printBtn.disabled = true;
          downloadBtn.disabled = true;
          return;
        }

        // The API returns the full rendered admit.html markup as `html`.
        previewContainer.innerHTML = body.html;
        previewStatus.textContent = `Preview generated — ${document.querySelectorAll('.a4-page').length} page(s).`;
        previewStatus.classList.remove('text-blue-400');
        previewStatus.classList.add('text-green-500');
        printBtn.disabled = false;
        downloadBtn.disabled = false;
      } catch (err) {
        console.error(err);
        previewStatus.textContent = 'Unexpected error occurred while fetching preview.';
        previewStatus.classList.remove('text-blue-400');
        previewStatus.classList.add('text-red-500');
        previewContainer.innerHTML = '';
        printBtn.disabled = true;
        downloadBtn.disabled = true;
      } finally {
        previewBtn.disabled = false;
        previewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    });

    printBtn.addEventListener('click', () => {
      // Open new window and write the preview HTML for printing
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        previewStatus.textContent = 'Unable to open new window for printing.';
        previewStatus.classList.remove('text-green-500');
        previewStatus.classList.add('text-red-500');
        return;
      }

      printWindow.document.open();
      printWindow.document.write(previewContainer.innerHTML);
      printWindow.document.close();

      printWindow.onload = () => {
        printWindow.focus();
        printWindow.print();
      };
    });

    downloadBtn.addEventListener('click', () => {
      // Open the preview in a new window/tab without auto-print
      const newWin = window.open('', '_blank');
      if (!newWin) {
        previewStatus.textContent = 'Unable to open new window.';
        previewStatus.classList.remove('text-green-500');
        previewStatus.classList.add('text-red-500');
        return;
      }
      newWin.document.open();
      newWin.document.write(previewContainer.innerHTML);
      newWin.document.close();
    });
    
  });

</script>

{% endblock %}