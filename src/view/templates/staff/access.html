{% extends 'base.html' %}
{% block title %}Access Control{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="m-0">Access Control - {{ t.Name }}</h3>
  <div class="d-flex gap-2">
    <a class="btn btn-secondary" href="/staff/{{ t.id }}">Back</a>
    <button class="btn btn-primary" onclick="applyRoleDefaults({{ t.id }})">Apply Role Defaults</button>
  </div>
</div>

<div class="card bg-dark border-secondary">
  <div class="card-body">
    <div class="mb-3">
      <label class="form-label">Class Access</label>
      <select id="classAccessSelect" class="form-select" multiple>
        {% for c in classes %}
          <option value="{{ c.id }}" {{ 'selected' if c.id in current_class_ids }}>{{ c.CLASS }}{{ '-' + c.Section if c.Section }}</option>
        {% endfor %}
      </select>
      <div class="mt-2">
        <button class="btn btn-sm btn-outline-light" onclick="saveClasses({{ t.id }})">Save Class Access</button>
      </div>
      <hr class="border-secondary"/>
    </div>
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle">
        <thead>
          <tr>
            <th>Feature</th>
            <th>Action</th>
            <th>Granted</th>
          </tr>
        </thead>
        <tbody>
          {% for p in permissions %}
          <tr>
            <td>{{ p.title or p.permission_name }}</td>
            <td class="text-muted small">{{ p.description }}</td>
            <td>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="perm{{ p.id }}" {% if p.id in granted_ids %}checked{% endif %}
                  onchange="togglePerm({{ t.id }}, {{ p.id }}, this.checked)">
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
</div>

<script>
async function togglePerm(staffId, permissionId, grant){
  const res = await fetch(`/staff/access/${staffId}/toggle`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({permission_id: permissionId, grant})
  });
  const data = await res.json();
  if(res.ok) showAlert(200, data.message); else showAlert(res.status, data.message||'Failed');
}

async function applyRoleDefaults(staffId){
  const res = await fetch(`/staff/access/${staffId}/apply_role_defaults`, {method:'POST'});
  const data = await res.json();
  if(res.ok) showAlert(200, data.message); else showAlert(res.status, data.message||'Failed');
}

async function saveClasses(staffId){
  const select = document.getElementById('classAccessSelect');
  const ids = Array.from(select.selectedOptions).map(o=>o.value);
  const res = await fetch(`/staff/access/${staffId}/classes`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({class_ids: ids})});
  const data = await res.json();
  if(res.ok) showAlert(200, data.message); else showAlert(res.status, data.message||'Failed');
}
</script>
{% endblock %}

